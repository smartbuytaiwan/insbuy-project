<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>拍拍購 InsBuy</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081840.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    [v-cloak] { display: none; }
    body { background-color: #F1F5F9; font-family: 'Noto Sans TC', sans-serif; padding-bottom: 0; color: #1e293b; -webkit-tap-highlight-color: transparent; }
    
    /* === 3. 現代科技紅主題 (Modern Red Tech) === */
    .tech-card { @apply bg-white rounded-2xl shadow-lg border-l-4 border-rose-500 p-5 mb-4 transition-all hover:shadow-xl; }
    .tech-input-label { @apply block text-xs font-bold text-rose-500 mb-1 tracking-wider uppercase; }
    .tech-input { @apply w-full h-[50px] bg-slate-50 border border-slate-200 rounded-xl px-4 text-[15px] focus:bg-white focus:border-rose-500 focus:ring-4 focus:ring-rose-100 outline-none transition-all font-medium text-slate-700; }
    
    .btn-tech { 
        @apply w-full h-[54px] rounded-xl font-bold text-white shadow-lg shadow-rose-500/30 transition-all active:scale-95 flex items-center justify-center text-[16px] bg-gradient-to-r from-rose-600 to-red-500 cursor-pointer hover:shadow-rose-500/50 hover:-translate-y-0.5; 
    }
    
    /* 5. 商品圖片：直式、置中 */
    .product-img-container { @apply w-full aspect-[3/4] bg-white flex items-center justify-center overflow-hidden relative border-b border-slate-100; }
    .product-img { @apply w-full h-full object-contain object-center; }

    /* 2. 底部導航 (橫向紅色) */
    .bottom-nav { 
        @apply fixed bottom-0 left-0 right-0 h-[70px] bg-gradient-to-r from-rose-600 to-red-700 text-white flex justify-around items-center z-[999] shadow-[0_-4px_20px_rgba(225,29,72,0.3)] max-w-md mx-auto rounded-t-2xl; 
    }
    .nav-item { @apply flex flex-col items-center justify-center w-full h-full text-white/70 active:text-white active:scale-95 transition cursor-pointer; }
    .nav-item.active { @apply text-white font-bold; }
    .nav-icon { @apply text-xl mb-0.5; }
    .nav-text { @apply text-[10px]; }

    /* 通用 UI */
    .capsule-btn { @apply px-4 py-1.5 rounded-full text-xs font-bold border transition-all whitespace-nowrap cursor-pointer select-none shadow-sm bg-white text-slate-500 border-slate-200; }
    .capsule-btn.active { @apply bg-rose-600 text-white border-rose-600 shadow-md; }
    .select-tag { @apply border border-slate-200 bg-white text-slate-500 rounded-full px-5 py-2.5 text-sm font-bold transition-all duration-300 cursor-pointer active:scale-95 select-none shadow-sm flex items-center gap-2 justify-center min-w-[80px]; }
    .select-tag.active { @apply border-rose-500 bg-rose-50 text-rose-600 shadow-md transform scale-105; }

    .safe-pb { padding-bottom: 100px; }
    .back-btn { @apply absolute top-3 left-3 z-50 w-10 h-10 bg-black/60 text-white rounded-full flex items-center justify-center backdrop-blur-md shadow-md active:scale-90 transition; }
    .img-preview { @apply w-full aspect-[3/4] object-cover rounded-xl border border-slate-200 shadow-sm bg-slate-50; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    .status-badge { @apply px-2 py-0.5 rounded-md text-[10px] font-bold; }
    .status-pending { @apply bg-orange-100 text-orange-600; }
    .status-shipped { @apply bg-blue-100 text-blue-600; }
    .status-completed { @apply bg-green-100 text-green-600; }
  </style>
</head>
<body>
  <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative bg-[#F1F5F9] flex flex-col shadow-2xl overflow-hidden pb-20">
    
    <div v-if="loading" class="fixed inset-0 bg-white/90 z-[9999] flex items-center justify-center flex-col backdrop-blur-sm">
        <div class="w-10 h-10 border-4 border-rose-100 border-t-rose-600 rounded-full animate-spin"></div>
        <div class="mt-3 text-rose-600 font-bold text-sm tracking-widest animate-pulse">LOADING...</div>
    </div>

    <div v-if="!['buyer-login', 'admin-login'].includes(view)" class="bg-white/90 backdrop-blur-md border-b border-slate-200 pt-12 pb-3 px-5 sticky top-0 z-40 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <button v-if="view !== 'shop' && view !== 'admin-home' && view !== 'buyer-dashboard'" @click="goBack" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-600"><i class="fa-solid fa-chevron-left"></i></button>
            <h2 class="text-lg font-black tracking-tight text-slate-800">{{ viewTitle }}</h2>
        </div>
        <div class="flex gap-2">
            <button v-if="view==='shop'" @click="shareLink" class="w-8 h-8 rounded-full bg-rose-50 text-rose-600 flex items-center justify-center"><i class="fa-solid fa-share-nodes"></i></button>
        </div>
    </div>

    <div v-if="view === 'shop'" class="p-4 safe-pb pt-4">
        <div class="mb-4 flex items-center justify-between">
            <div><h1 class="text-2xl font-black text-slate-800">{{ shopName }}</h1><p class="text-xs text-slate-400 font-mono mt-1">ID: {{ currentShopId }}</p></div>
            <div class="flex flex-col items-end gap-1">
                <div v-if="shopLevel>=99" class="bg-yellow-400 text-slate-900 text-xs px-2 py-1 rounded-lg font-bold shadow-sm">VIP</div>
                <select v-model="shopSort" class="text-xs border border-slate-200 rounded px-1 py-1 bg-white outline-none"><option value="newest">最新</option><option value="priceLow">價格低</option><option value="priceHigh">價格高</option></select>
            </div>
        </div>

        <div v-if="sortedProducts.length > 0" class="grid grid-cols-2 gap-3">
            <div v-for="p in sortedProducts" :key="p.product_id" @click="openProduct(p)" class="bg-white rounded-xl overflow-hidden shadow-sm active:scale-[0.98] transition cursor-pointer relative border border-slate-100">
                <div v-if="p.is_pinned" class="absolute top-2 left-2 z-10 bg-rose-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm"><i class="fa-solid fa-thumbtack mr-1"></i>推薦</div>
                <div class="product-img-container"><img :src="p.images?.split('\n')[0]" class="product-img"><div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded-full font-bold">{{ getCountdown(p.end_time) }}</div></div>
                <div class="p-3">
                    <div class="font-bold text-slate-800 line-clamp-1 text-[14px] mb-1">{{ p.name }}</div>
                    <div class="flex justify-between items-end mt-2">
                        <div><span class="text-[10px] text-slate-400 line-through mr-1" v-if="p.original_price > p.price">${{p.original_price}}</span><span class="text-rose-600 font-black text-base">${{ p.price }}</span></div>
                        <div class="w-7 h-7 rounded-full bg-rose-50 text-rose-600 flex items-center justify-center"><i class="fa-solid fa-plus text-xs"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div v-else class="text-center py-20 text-slate-400"><i class="fa-solid fa-store text-4xl mb-2"></i><p class="mt-2">暫無商品</p></div>
    </div>

    <div v-if="view === 'product' && selectedProduct" class="bg-white min-h-screen safe-pb relative z-50">
        <button @click="view='shop'" class="back-btn"><i class="fa-solid fa-arrow-left"></i></button>
        <div class="product-img-container h-[400px]">
            <img :src="selectedProduct.images?.split('\n')[0]" class="product-img">
        </div>
        
        <div class="p-6 bg-white rounded-t-[30px] -mt-6 relative shadow-[0_-5px_20px_rgba(0,0,0,0.05)] border-t border-slate-100">
             <div class="flex justify-between items-end mb-2">
                 <div class="flex items-end gap-2"><span class="text-3xl font-black text-rose-600 tracking-tight">${{ selectedProduct.price }}</span><span class="text-sm text-slate-400 line-through mb-1" v-if="selectedProduct.original_price > 0">${{ selectedProduct.original_price }}</span></div>
                 <div class="text-xs text-slate-400 font-bold mb-1">庫存: {{ currentVariantStock }}</div>
             </div>
             <h1 class="text-xl font-bold text-slate-800 leading-snug mb-4">{{ selectedProduct.name }}</h1>
             
             <div v-if="shopLineId" class="mb-4">
                 <a :href="'https://line.me/ti/p/~' + shopLineId" target="_blank" class="flex items-center gap-2 bg-[#06C755] text-white px-4 py-2 rounded-xl font-bold text-sm w-fit hover:opacity-90">
                     <i class="fa-brands fa-line text-lg"></i> 聯絡賣家 ({{ shopLineId }})
                 </a>
             </div>

             <div class="text-sm text-slate-600 mb-6 bg-slate-50 p-4 rounded-xl whitespace-pre-line leading-relaxed border border-slate-100">{{ selectedProduct.description }}</div>
             
             <div class="mb-6" v-if="selectedProduct.shipping_rules"><h3 class="text-xs font-bold text-slate-400 mb-2">運送規則</h3><div class="flex flex-wrap gap-2"><div v-for="rule in parseJson(selectedProduct.shipping_rules)" :key="rule.name" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg border border-blue-100 font-bold"><i class="fa-solid fa-truck-fast mr-1"></i> {{ rule.name }} ${{rule.fee}} <span v-if="rule.limit">(滿{{rule.limit}}件免運)</span></div></div></div>

             <div class="space-y-4">
                 <div v-if="selectedProduct.variants?.length && selectedProduct.variants[0].name"><label class="input-label">選擇規格</label><div class="flex flex-wrap gap-2"><button v-for="v in selectedProduct.variants" @click="orderForm.variant=v.name" class="select-tag" :class="orderForm.variant===v.name ? 'active' : ''">{{ v.name }}</button></div></div>
                 <div class="flex items-center justify-between bg-slate-50 p-3 rounded-2xl border border-slate-100"><label class="font-bold text-slate-700 ml-1">數量</label><div class="flex items-center bg-white shadow-sm rounded-xl h-10 border border-slate-100 w-32"><button @click="orderForm.qty > 1 ? orderForm.qty-- : null" class="w-10 h-full text-slate-500 rounded-l-xl hover:bg-slate-50">-</button><span class="flex-1 text-center font-bold text-slate-800 text-sm">{{ orderForm.qty }}</span><button @click="orderForm.qty < currentVariantStock ? orderForm.qty++ : null" class="w-10 h-full text-slate-500 rounded-r-xl hover:bg-slate-50">+</button></div></div>
             </div>
        </div>
        <div class="fixed bottom-[80px] left-0 right-0 px-4 pb-2 z-40 max-w-md mx-auto flex gap-3">
            <button @click="view='shop'" class="flex-1 btn-outline bg-white">繼續選購</button>
            <button @click="addToCart" class="flex-1 btn-tech shadow-lg text-white">加入購物車</button>
        </div>
    </div>

    <div v-if="view === 'buyer-login'" class="p-6 pt-20 flex flex-col min-h-screen bg-white">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-rose-100 text-rose-600 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-4 shadow-sm"><i class="fa-solid fa-user"></i></div>
            <h1 class="text-2xl font-black text-slate-800">{{ buyerAuthMode === 'login' ? '買家登入' : (buyerAuthMode === 'register' ? '註冊會員' : '忘記密碼') }}</h1>
            <p class="text-sm text-slate-400 mt-2">享受更完整的購物體驗</p>
        </div>

        <div v-if="buyerAuthMode === 'login'" class="space-y-4">
            <div><label class="input-label">手機號碼</label><input v-model="buyerForm.phone" type="tel" class="input-box" placeholder="09xxxxxxxx"></div>
            <div><label class="input-label">密碼</label><input v-model="buyerForm.password" type="password" class="input-box" placeholder="••••••••"></div>
            <button @click="loginBuyerSubmit" class="btn-tech mt-4">登入</button>
        </div>

        <div v-if="buyerAuthMode === 'register'" class="space-y-4">
            <div><label class="input-label">姓名</label><input v-model="buyerForm.name" class="input-box" placeholder="您的稱呼"></div>
            <div><label class="input-label">手機號碼</label><input v-model="buyerForm.phone" type="tel" class="input-box" placeholder="09xxxxxxxx"></div>
            <div><label class="input-label">電子信箱</label><input v-model="buyerForm.email" type="email" class="input-box" placeholder="email@example.com"></div>
            <div><label class="input-label">設定密碼</label><input v-model="buyerForm.password" type="password" class="input-box" placeholder="••••••••"></div>
            <button @click="registerBuyerSubmit" class="btn-tech mt-4">立即註冊</button>
        </div>

        <div v-if="buyerAuthMode === 'reset'" class="space-y-4">
            <p class="text-sm text-slate-500 mb-2">請輸入您的信箱，我們將寄送重設連結給您。</p>
            <div><label class="input-label">電子信箱</label><input v-model="buyerForm.email" type="email" class="input-box" placeholder="email@example.com"></div>
            <button @click="resetBuyerPassword" class="btn-tech mt-4">發送重設信</button>
        </div>

        <div class="mt-6 flex justify-center gap-4 text-xs text-slate-400 font-bold">
            <span v-if="buyerAuthMode !== 'login'" @click="buyerAuthMode='login'" class="cursor-pointer hover:text-rose-600">返回登入</span>
            <span v-if="buyerAuthMode === 'login'" @click="buyerAuthMode='register'" class="cursor-pointer hover:text-rose-600">註冊帳號</span>
            <span v-if="buyerAuthMode === 'login'" @click="buyerAuthMode='reset'" class="cursor-pointer hover:text-rose-600">忘記密碼?</span>
        </div>
    </div>

    <div v-if="view === 'buyer-dashboard'" class="p-4 safe-pb pt-4">
        <div class="bg-gradient-to-r from-rose-600 to-red-500 rounded-2xl p-6 text-white mb-6 shadow-lg shadow-rose-200">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold">{{ buyerProfile.name }}</h2>
                    <p class="text-sm opacity-80 mt-1">{{ buyerProfile.phone }}</p>
                </div>
                <button @click="logoutBuyer" class="bg-white/20 px-3 py-1 rounded-full text-xs hover:bg-white/30">登出</button>
            </div>
            <div class="mt-6 flex gap-4">
                <div><div class="text-xs opacity-70">總消費</div><div class="text-xl font-bold">${{ buyerStats.totalSpent }}</div></div>
                <div><div class="text-xs opacity-70">訂單數</div><div class="text-xl font-bold">{{ buyerStats.orderCount }}</div></div>
            </div>
        </div>

        <h3 class="font-bold text-slate-700 mb-3 ml-1">歷史訂單</h3>
        <div v-if="buyerOrders.length > 0" class="space-y-3">
            <div v-for="order in buyerOrders" :key="order.order_id" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex justify-between mb-2 pb-2 border-b border-slate-50">
                    <span class="text-xs text-slate-400">{{ new Date(order.created_at).toLocaleDateString() }}</span>
                    <span class="status-badge" :class="{'status-pending': order.status==='PENDING', 'status-shipped': order.status==='SHIPPED', 'status-completed': order.status==='COMPLETED'}">{{ getStatusText(order.status) }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-bold text-slate-700">{{ parseJson(order.items)[0]?.name }}...等</span>
                    <span class="text-rose-600 font-bold">${{ order.total_amount }}</span>
                </div>
            </div>
        </div>
        <div v-else class="text-center py-10 text-slate-400 text-sm">尚無訂單記錄</div>
    </div>

    <div v-if="view === 'admin-create'" class="p-4 pb-24 space-y-5">
        <div class="tech-card">
            <h3 class="text-lg font-black text-slate-800 mb-4 flex items-center"><span class="w-1 h-6 bg-rose-500 rounded-full mr-2"></span>基本資訊</h3>
            <div class="space-y-4">
                <div><label class="tech-input-label">商品名稱</label><input v-model="newProduct.name" class="tech-input" placeholder="請輸入吸睛標題"></div>
                <div><label class="tech-input-label">商品描述</label><textarea v-model="newProduct.description" class="tech-input h-32 py-3" placeholder="介紹您的商品..."></textarea></div>
                <div class="flex items-center"><input type="checkbox" v-model="newProduct.is_pinned" class="w-5 h-5 accent-rose-500 mr-2"><span class="text-sm font-bold text-slate-600">置頂推廣</span></div>
            </div>
        </div>

        <div class="tech-card">
            <h3 class="text-lg font-black text-slate-800 mb-4 flex items-center"><span class="w-1 h-6 bg-rose-500 rounded-full mr-2"></span>圖片上傳</h3>
            <div class="grid grid-cols-3 gap-3">
                <div v-for="(img, idx) in previewImages" :key="idx" class="relative group"><img :src="img" class="img-preview"><button @click="removeImage(idx)" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-md"><i class="fa-solid fa-times"></i></button></div>
                <label v-if="previewImages.length < currentLevelConfig.max_images" class="aspect-[3/4] bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:border-rose-400 hover:text-rose-500 transition"><i class="fa-solid fa-camera text-2xl mb-1"></i><span class="text-[10px] font-bold">上傳</span><input type="file" multiple accept="image/*" class="hidden" @change="handleFileUpload"></label>
            </div>
        </div>

        <div class="tech-card">
            <h3 class="text-lg font-black text-slate-800 mb-4 flex items-center"><span class="w-1 h-6 bg-rose-500 rounded-full mr-2"></span>價格與庫存</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="tech-input-label">團購價</label><input v-model="newProduct.price" type="number" class="tech-input"></div>
                <div><label class="tech-input-label text-slate-400">原價</label><input v-model="newProduct.originalPrice" type="number" class="tech-input"></div>
            </div>
            <div><label class="tech-input-label">總庫存</label><input v-model="newProduct.stock" type="number" class="tech-input text-center font-bold" placeholder="未開規格時使用"></div>
            
            <div class="mt-6 pt-4 border-t border-slate-100">
                <div class="flex justify-between items-center mb-3"><span class="tech-input-label mb-0">多規格設定</span><button @click="addVariant" class="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold">+ 新增</button></div>
                <div class="space-y-2">
                    <div v-for="(v, idx) in newProduct.variants" :key="idx" class="flex gap-2 items-center"><input v-model="v.name" class="tech-input h-10 text-sm" placeholder="規格名"><input v-model="v.price" type="number" class="tech-input h-10 text-sm w-20 text-center" placeholder="+價"><input v-model="v.stock" type="number" class="tech-input h-10 text-sm w-16 text-center" placeholder="存"><i @click="newProduct.variants.splice(idx,1)" class="fa-solid fa-trash text-slate-300 p-2 hover:text-red-500 cursor-pointer"></i></div>
                </div>
            </div>
        </div>

        <div class="tech-card">
            <h3 class="text-lg font-black text-slate-800 mb-4 flex items-center"><span class="w-1 h-6 bg-rose-500 rounded-full mr-2"></span>運送與提問</h3>
            <label class="tech-input-label">運送方式</label>
            <div class="flex flex-wrap gap-2 mb-4"><div v-for="t in logisticsOptions" :key="t" @click="addShippingRule(t)" class="select-tag" :class="newProduct.shipping.some(s=>s.name===t)?'active':''">{{ t }}</div></div>
            
            <div v-if="newProduct.shipping.length > 0" class="space-y-2 mb-6"><div v-for="(rule, idx) in newProduct.shipping" :key="idx" class="bg-rose-50 border border-rose-100 rounded-xl p-3"><div class="flex justify-between items-center mb-2"><span class="text-sm font-bold text-rose-700 flex items-center gap-2"><i class="fa-solid fa-truck"></i> {{ rule.name }}</span><i @click="newProduct.shipping.splice(idx,1)" class="fa-solid fa-times text-slate-300 cursor-pointer hover:text-red-500"></i></div><div class="flex gap-2"><div class="flex-1"><span class="text-[10px] text-slate-400 block mb-1">運費</span><input v-model="rule.fee" type="number" class="tech-input h-8 text-center text-sm"></div><div class="flex-1"><span class="text-[10px] text-slate-400 block mb-1">免運門檻</span><input v-model="rule.limit" type="number" class="tech-input h-8 text-center text-sm"></div></div></div></div>

            <div class="pt-4 border-t border-slate-100"><label class="tech-input-label">買家提問欄位</label><div class="space-y-2 mb-3"><div v-for="(q, idx) in newProduct.questions" :key="idx" class="flex gap-2 items-center"><input v-model="q.title" class="tech-input h-10 text-sm" placeholder="問題標題"><label class="text-xs whitespace-nowrap flex items-center gap-1"><input type="checkbox" v-model="q.required">必填</label><i @click="newProduct.questions.splice(idx,1)" class="fa-solid fa-trash text-slate-300 p-1 hover:text-red-500 cursor-pointer"></i></div></div><button @click="addQuestion" class="w-full py-2 border-2 border-dashed border-slate-200 text-slate-400 rounded-xl text-sm font-bold">+ 新增問題</button></div>
        </div>

        <button @click="saveProduct" class="btn-tech text-lg shadow-xl">確認上架</button>
    </div>

    <div v-if="view === 'admin-login'" class="flex-1 flex flex-col items-center justify-center p-6 bg-white min-h-screen">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-rose-600 mb-2">賣家中心</h1>
            <p class="text-slate-400 text-sm">{{ authMode === 'login' ? '登入管理您的商店' : '加入我們，開始接單' }}</p>
        </div>
        
        <div v-if="authMode === 'login'" class="w-full max-w-sm space-y-4">
            <div><label class="input-label">Email</label><input v-model="loginForm.email" class="input-box"></div>
            <div><label class="input-label">密碼</label><input v-model="loginForm.password" type="password" class="input-box"></div>
            <button @click="adminLogin" class="btn-tech mt-4">登入後台</button>
        </div>

        <div v-if="authMode === 'register'" class="w-full max-w-sm space-y-4">
            <div><label class="input-label">商店 ID (網址用)</label><input v-model="registerForm.shop_id" class="input-box"></div>
            <div><label class="input-label">商店名稱</label><input v-model="registerForm.name" class="input-box"></div>
            <div><label class="input-label">Line ID / 官方帳號</label><input v-model="registerForm.line_id" class="input-box" placeholder="供買家聯繫用"></div>
            <div><label class="input-label">Email</label><input v-model="registerForm.email" class="input-box"></div>
            <div><label class="input-label">密碼</label><input v-model="registerForm.password" type="password" class="input-box"></div>
            <button @click="registerShop" class="btn-tech mt-4">註冊商店</button>
        </div>

        <div v-if="authMode === 'reset'" class="w-full max-w-sm space-y-4">
            <div><label class="input-label">Email</label><input v-model="resetFormModel.email" class="input-box"></div>
            <div><label class="input-label">新密碼</label><input v-model="resetFormModel.password" type="password" class="input-box"></div>
            <button @click="resetPassword" class="btn-tech mt-4">重設密碼</button>
        </div>

        <div class="mt-8 flex gap-4 text-sm text-slate-400 font-bold">
            <span v-if="authMode!=='login'" @click="authMode='login'" class="cursor-pointer hover:text-rose-600">登入</span>
            <span v-if="authMode==='login'" @click="authMode='register'" class="cursor-pointer hover:text-rose-600">註冊開店</span>
            <span v-if="authMode==='login'" @click="authMode='reset'" class="cursor-pointer hover:text-rose-600">忘記密碼</span>
        </div>
    </div>

    <div v-if="view === 'admin-home'" class="p-4 pb-24">
        <div class="bg-gradient-to-br from-rose-600 to-red-500 rounded-2xl p-5 text-white mb-6 shadow-lg shadow-rose-200 relative">
            <div class="flex items-center"><div class="text-2xl font-bold mr-3">{{ shopName }}</div><span class="bg-white/20 px-2 py-0.5 rounded text-xs">Lv.{{ shopLevel }}</span></div>
            <div class="text-xs opacity-80 mt-1">ID: {{ currentShopId }}</div>
            <button @click="logout" class="absolute top-5 right-5 bg-white/20 px-3 py-1 rounded-full text-xs">登出</button>
        </div>
        <div class="grid grid-cols-3 gap-3 mb-6">
            <div @click="goToCreateProduct" class="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 cursor-pointer active:scale-95 transition"><i class="fa-solid fa-plus text-2xl text-rose-500"></i><span class="text-xs font-bold text-slate-600">新增</span></div>
            <div @click="view='admin-orders'" class="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 cursor-pointer active:scale-95 transition"><i class="fa-solid fa-clipboard-list text-2xl text-blue-500"></i><span class="text-xs font-bold text-slate-600">訂單</span></div>
            <div v-if="shopLevel>=99 || currentShopId==='S001'" @click="view='admin-vip'" class="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 cursor-pointer active:scale-95 transition"><i class="fa-solid fa-user-shield text-2xl text-purple-500"></i><span class="text-xs font-bold text-slate-600">權限</span></div>
        </div>
        <div class="capsule-tabs"><div @click="adminTab='OPEN'" class="capsule-btn" :class="adminTab==='OPEN' ? 'active' : 'inactive'">團購中</div><div @click="adminTab='CLOSED'" class="capsule-btn" :class="adminTab==='CLOSED' ? 'active' : 'inactive'">已結束</div><div @click="adminTab='ARCHIVED'" class="capsule-btn" :class="adminTab==='ARCHIVED' ? 'active' : 'inactive'">已刪除</div></div>
        <div v-if="filteredAdminProducts.length > 0" class="space-y-3"><div v-for="p in filteredAdminProducts" :key="p.product_id" class="bg-white p-3 rounded-xl shadow-sm flex gap-3 cursor-pointer" @click="editProduct(p)"><img :src="p.images?.split('\n')[0]" class="w-16 h-16 rounded-lg object-cover bg-slate-50"><div class="flex-1"><div class="font-bold text-sm text-slate-800 line-clamp-1">{{ p.name }}</div><div class="text-xs text-rose-500 font-bold mt-1">${{p.price}}</div><div class="flex gap-2 mt-2 justify-end"><button v-if="adminTab==='OPEN'" @click.stop="updateStatus(p.product_id, 'CLOSED')" class="text-[10px] bg-slate-100 px-2 py-1 rounded">結團</button><button v-if="adminTab!=='ARCHIVED'" @click.stop="updateStatus(p.product_id, 'ARCHIVED')" class="text-[10px] bg-red-50 text-red-500 px-2 py-1 rounded">刪除</button></div></div></div></div>
        <div v-else class="text-center py-20 text-slate-300">無商品</div>
    </div>

    <div v-if="view === 'admin-orders'" class="p-4 safe-pb">
        <div class="flex justify-between mb-4"><h2 class="font-bold text-lg text-slate-700">訂單管理</h2><button @click="exportToExcel" class="text-xs bg-emerald-100 text-emerald-600 px-3 py-1.5 rounded-lg font-bold">匯出</button></div>
        <div v-if="adminOrderList.length > 0" class="space-y-3">
            <div v-for="order in adminOrderList" :key="order.order_id" class="bg-white p-4 rounded-xl shadow-sm flex gap-3">
                <img v-if="parseJson(order.items)[0]?.images" :src="parseJson(order.items)[0].images.split('\n')[0]" class="w-14 h-14 rounded-lg object-cover bg-slate-50">
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between border-b border-slate-50 pb-2 mb-2"><span class="font-bold text-sm text-slate-800">{{ order.receiver_name }}</span><span class="text-xs text-slate-400">{{ new Date(order.created_at).toLocaleDateString() }}</span></div>
                    <div class="flex justify-between items-center"><span class="text-base font-black text-rose-600">${{ order.total_amount }}</span><select v-model="order.status" @change="updateOrderStatus(order)" class="status-select"><option value="PENDING">待處理</option><option value="PAID">已付款</option><option value="SHIPPED">已出貨</option><option value="COMPLETED">已完成</option><option value="CANCELLED">已取消</option></select></div>
                </div>
            </div>
        </div>
        <div v-else class="text-center py-20 text-slate-400">無訂單</div>
    </div>

    <div v-if="view === 'admin-vip'" class="p-4 safe-pb">
        <div class="card"><div class="section-header"><i class="fa-solid fa-magnifying-glass mr-2 text-blue-500"></i><span class="section-title text-sm">搜尋商家</span></div><div class="flex gap-2 mb-3"><input v-model="searchQuery" class="input-box h-10 text-sm" placeholder="輸入Email或名稱..."></div><div class="max-h-60 overflow-y-auto space-y-2"><div v-for="shop in filteredShops" :key="shop.shop_id" class="flex justify-between items-center p-2 bg-slate-50 rounded-lg border border-slate-100"><div class="truncate flex-1 mr-2"><div class="font-bold text-sm text-slate-700">{{ shop.name }}</div><div class="text-[10px] text-slate-400">{{ shop.email }}</div></div><input type="number" v-model.number="shop.level" @change="updateShopLevel(shop)" class="input-box w-16 h-8 text-center text-sm"></div></div></div>
        <button @click="saveLevelConfigs" class="btn-tech h-12 text-sm mt-4">儲存設定</button>
    </div>

    <div v-if="view === 'cart'" class="bg-[#F1F5F9] min-h-screen safe-pb pt-4 px-4">
        <div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg text-slate-800">購物車</h2><button @click="cart=[]" class="text-xs text-slate-400">清空</button></div>
        <div v-if="cart.length>0" class="space-y-3">
            <div v-for="(item,idx) in cart" :key="idx" class="bg-white p-3 rounded-xl shadow-sm flex gap-3 relative"><img :src="item.images?.split('\n')[0]" class="w-20 h-20 rounded-lg object-cover bg-slate-50"><div class="flex-1 py-1"><div class="font-bold text-sm text-slate-800">{{item.name}}</div><div class="text-rose-600 font-bold mt-1">${{item.finalPrice}} x {{item.qty}}</div><div class="text-[10px] text-slate-400 mt-1">規格: {{item.variant||'單一'}}</div></div><button @click="cart.splice(idx,1)" class="absolute top-3 right-3 text-slate-300"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="fixed bottom-[80px] left-0 right-0 px-4 pb-2 z-40 max-w-md mx-auto"><button @click="view='checkout_fill'" class="btn-tech shadow-lg">前往結帳 (${{ cartTotal }})</button></div>
        </div>
        <div v-else class="text-center py-32 text-slate-300">購物車是空的</div>
    </div>

    <div v-if="view === 'checkout_fill'" class="bg-[#F1F5F9] min-h-screen safe-pb p-4 space-y-4">
        <div class="card"><div class="font-bold text-slate-800 border-l-4 border-rose-500 pl-2 mb-3 text-sm">收件人</div><div class="mb-3"><label class="input-label">姓名</label><input v-model="checkoutForm.name" class="input-box" placeholder="證件姓名"></div><div><label class="input-label">電話</label><input v-model="checkoutForm.phone" class="input-box" type="tel" placeholder="09xxxxxxxx"></div></div>
        <div class="card"><div class="font-bold text-slate-800 border-l-4 border-rose-500 pl-2 mb-3 text-sm">取貨</div><div class="flex flex-wrap gap-2 mb-3"><button v-for="m in logisticsOptions" :key="m" @click="checkoutForm.method=m" class="select-tag" :class="checkoutForm.method===m?'active':''">{{ m }}</button></div><div><label class="input-label">門市/地址</label><input v-model="checkoutForm.store" class="input-box" placeholder="輸入地址或門市"></div></div>
        <div class="fixed bottom-[80px] left-0 right-0 px-4 pb-2 z-40 max-w-md mx-auto"><button @click="submitOrder" class="btn-tech shadow-lg">送出訂單</button></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" :class="{active: view==='shop'}" @click="view='shop'">
            <i class="fa-solid fa-store nav-icon"></i><span class="nav-text">首頁</span>
        </div>
        <div class="nav-item" :class="{active: view==='cart'}" @click="view='cart'">
            <div class="relative"><i class="fa-solid fa-cart-shopping nav-icon"></i><span v-if="cart.length>0" class="absolute -top-1 -right-2 bg-yellow-400 text-rose-700 text-[9px] w-4 h-4 rounded-full flex justify-center items-center font-bold">{{cart.length}}</span></div><span class="nav-text">購物車</span>
        </div>
        <div v-if="!isAdminLoggedIn" class="nav-item" :class="{active: view==='buyer-dashboard' || view==='buyer-login'}" @click="checkBuyerLogin">
            <i class="fa-solid fa-user nav-icon"></i><span class="nav-text">我的</span>
        </div>
        <div class="nav-item" :class="{active: view.includes('admin')}" @click="goToAdmin">
            <i class="fa-solid fa-briefcase nav-icon"></i><span class="nav-text">賣家</span>
        </div>
    </div>

  </div>

  <script>
    const API_BASE = 'https://insbuy-project.onrender.com/api'; 
    const SUPABASE_URL = 'https://robgmhyjdfizzxdddqzr.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_WlEj-PHW5HuMZ94HXNJYyA_pKYERes4'; 
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    Vue.createApp({
        data() {
            return {
                view: 'shop',
                loading: false,
                currentShopId: 'S001',
                shopName: 'INSBUY',
                shopLevel: 1, 
                shopLineId: '', // 4. 賣家 Line ID
                products: [],
                cart: [],
                // 1. 買家相關資料
                buyerAuthMode: 'login',
                buyerProfile: null,
                buyerOrders: [],
                buyerForm: { name: '', phone: '', email: '', password: '' },
                
                // 賣家相關資料
                authMode: 'login',
                loginForm: { email: '', password: '' },
                registerForm: { shop_id: '', name: '', email: '', password: '', line_id: '' }, // 4. 新增 line_id
                resetFormModel: { email: '', password: '' },
                checkoutForm: { name: '', phone: '', method: '7-11', store: '', note: '' },
                
                isEditing: false,
                editingProductId: null,
                editingProductStatus: '',
                newProduct: { name: '', description: '', images: '', price: '', originalPrice: '', stock: '', is_pinned: false, variants: [{name:'', price:'', stock:''}], shipping: [], duration: '7', targetAmount: '', bank: { name: '', account: '' }, questions: [] },
                selectedProduct: null,
                orderForm: { variant: '', qty: 1 },
                previewImages: [],
                adminTab: 'OPEN',
                adminOrderList: [],
                commonBanks: ['中國信託 (822)', '國泰世華 (013)', '台北富邦 (012)', '玉山銀行 (808)', '台新銀行 (812)', '郵局 (700)', '臺灣銀行 (004)', '土地銀行 (005)', '永豐銀行 (807)'],
                logisticsOptions: ['7-11', '全家', '萊爾富', '黑貓宅配', '郵局寄送', '面交'],
                selectedBankName: '',
                saveBankInfo: false,
                now: Date.now(),
                allShops: [],
                searchQuery: '',
                levelConfigs: [],
                user: null,
                shopSort: 'newest',
                zoomedImage: null
            }
        },
        computed: {
            isAdminLoggedIn() { return !!localStorage.getItem('adminCreds'); },
            cartTotal() { return this.cart.reduce((sum, i) => sum + i.finalPrice * i.qty, 0); },
            filteredAdminProducts() { if(!this.products) return []; return this.products.filter(p => p.status === this.adminTab); },
            buyerProducts() { return this.products.filter(p => p.status === 'OPEN'); },
            sortedProducts() {
                let sorted = [...this.buyerProducts];
                if (this.shopSort === 'priceLow') sorted.sort((a,b) => a.price - b.price);
                else if (this.shopSort === 'priceHigh') sorted.sort((a,b) => b.price - a.price);
                else sorted.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)); 
                return sorted.sort((a,b) => (b.is_pinned === true ? 1 : 0) - (a.is_pinned === true ? 1 : 0));
            },
            viewTitle() { return {'shop':'拍拍購','admin-home':'賣家中心','admin-create':'商品編輯','buyer-dashboard':'會員中心'}[this.view] || 'InsBuy'; },
            filteredShops() { if(!this.searchQuery) return this.allShops; return this.allShops.filter(s => s.name?.includes(this.searchQuery) || s.email?.includes(this.searchQuery)); },
            currentLevelConfig() { return this.levelConfigs.find(c => c.level_id === this.shopLevel) || { max_images:3, max_variants:2, max_duration:7 }; },
            currentVariantStock() {
                if (this.selectedProduct?.variants?.length && this.orderForm.variant) {
                    const v = this.selectedProduct.variants.find(va => va.name === this.orderForm.variant);
                    return v ? (v.stock || 0) : 0;
                }
                return this.selectedProduct?.total_stock || 0;
            },
            buyerStats() {
                if (!this.buyerOrders.length) return { totalSpent: 0, orderCount: 0 };
                return {
                    totalSpent: this.buyerOrders.reduce((sum, o) => sum + (o.total_amount || 0), 0),
                    orderCount: this.buyerOrders.length
                };
            }
        },
        async mounted() {
            this.loading = true;
            setInterval(() => { this.now = Date.now(); this.checkAutoClose(); }, 60000);
            
            const urlParams = new URLSearchParams(window.location.search);
            const urlShopId = urlParams.get('shop_id');
            if (urlShopId) { this.currentShopId = urlShopId; } else { this.currentShopId = 'S001'; }
            
            const savedCreds = localStorage.getItem('adminCreds');
            if (savedCreds) { const creds = JSON.parse(savedCreds); this.currentShopId = creds.shop_id; }

            // 檢查買家登入
            const savedBuyer = localStorage.getItem('buyerProfile');
            if (savedBuyer) { this.buyerProfile = JSON.parse(savedBuyer); await this.fetchBuyerOrders(); }

            await this.loadAllData();
            this.loading = false;
            if(urlParams.get('mode') === 'admin') this.goToAdmin();
        },
        methods: {
            resetForm() {
                this.newProduct = { 
                    name: '', description: '', images: '', price: '', originalPrice: '', stock: '', is_pinned: false,
                    variants: [{name:'', price:'', stock:''}], 
                    shipping: [], duration: '7', targetAmount: '', 
                    bank: { name: '', account: '' }, 
                    questions: [] 
                };
                this.previewImages = [];
                const savedBank = localStorage.getItem('savedBank');
                if(savedBank) { const b = JSON.parse(savedBank); this.newProduct.bank = b; this.selectedBankName = b.name; }
            },

            parseJson(str) { try { return JSON.parse(str); } catch(e) { return []; } },
            getStatusText(s) { return {'PENDING':'待處理','PAID':'已付款','SHIPPED':'已出貨','COMPLETED':'已完成','CANCELLED':'已取消'}[s] || s; },

            async loadAllData() {
                await this.fetchShopInfo();
                await this.fetchProducts();
                await this.fetchLevelConfigs();
                if(this.shopLevel >= 99) await this.fetchAllShops();
                if(this.isAdminLoggedIn) await this.fetchAdminOrders();
            },

            async fetchShopInfo() {
                const { data } = await supabaseClient.from('shops').select('*').eq('shop_id', this.currentShopId).maybeSingle();
                if(data) { 
                    this.shopName = data.name; 
                    this.shopLevel = parseInt(data.level) || 1; 
                    this.shopLineId = data.line_id; // 4. 讀取 Line ID
                } else { this.shopName = '找不到商店'; }
            },
            async fetchProducts() { 
                const { data } = await supabaseClient.from('products').select('*').eq('shop_id', this.currentShopId).neq('status', 'REMOVED').order('created_at', {ascending: false}); 
                this.products = data || []; 
                this.products.forEach(p => { 
                    if(typeof p.variants === 'string') p.variants = JSON.parse(p.variants); 
                    if(typeof p.questions === 'string') p.questions = JSON.parse(p.questions); 
                });
                this.checkAutoClose();
            },
            async fetchAdminOrders() {
                const { data } = await supabaseClient.from('orders').select('*').eq('shop_id', this.currentShopId).order('created_at', {ascending: false});
                this.adminOrderList = data || [];
            },
            
            // --- 1. 買家系統邏輯 ---
            checkBuyerLogin() {
                if (this.buyerProfile) { this.view = 'buyer-dashboard'; this.fetchBuyerOrders(); }
                else { this.view = 'buyer-login'; }
            },
            async loginBuyerSubmit() {
                this.loading = true;
                const { data } = await supabaseClient.from('buyers').select('*').eq('phone', this.buyerForm.phone).eq('password', this.buyerForm.password).maybeSingle();
                this.loading = false;
                if(data) {
                    this.buyerProfile = data;
                    localStorage.setItem('buyerProfile', JSON.stringify(data));
                    this.view = 'buyer-dashboard';
                    this.fetchBuyerOrders();
                } else { alert('帳號或密碼錯誤'); }
            },
            async registerBuyerSubmit() {
                if(!this.buyerForm.phone || !this.buyerForm.password || !this.buyerForm.name) return alert('請填寫完整');
                this.loading = true;
                const { error } = await supabaseClient.from('buyers').insert(this.buyerForm);
                this.loading = false;
                if(error) alert('註冊失敗 (電話可能重複)'); else { alert('註冊成功'); this.buyerAuthMode = 'login'; }
            },
            resetBuyerPassword() { alert('系統已發送重設密碼信件至您的信箱 (模擬)'); },
            logoutBuyer() {
                localStorage.removeItem('buyerProfile');
                this.buyerProfile = null;
                this.view = 'shop';
            },
            async fetchBuyerOrders() {
                if(!this.buyerProfile) return;
                // 簡易版：用電話號碼連結訂單
                const { data } = await supabaseClient.from('orders').select('*').eq('receiver_phone', this.buyerProfile.phone).order('created_at', {ascending: false});
                this.buyerOrders = data || [];
            },

            // --- 賣家系統 ---
            goToCreateProduct() { this.resetForm(); this.isEditing = false; this.view = 'admin-create'; },
            async saveProduct() {
                if (this.previewImages.length > this.currentLevelConfig.max_images) return alert(`圖片上限 ${this.currentLevelConfig.max_images} 張`);
                if(!this.newProduct.name || !this.newProduct.price) return alert('請填寫完整');
                
                this.loading = true;
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + parseInt(this.newProduct.duration));
                if(this.saveBankInfo) localStorage.setItem('savedBank', JSON.stringify(this.newProduct.bank));

                let calculatedStock = Number(this.newProduct.stock);
                if (!calculatedStock && this.newProduct.variants.length > 0 && this.newProduct.variants[0].name !== '') {
                    calculatedStock = this.newProduct.variants.reduce((acc,v)=>acc+parseInt(v.stock||0), 0);
                }

                const payload = {
                    shop_id: this.currentShopId,
                    name: this.newProduct.name, description: this.newProduct.description, images: this.newProduct.images,
                    price: Number(this.newProduct.price) || 0, 
                    original_price: Number(this.newProduct.originalPrice) || 0,
                    status: this.isEditing ? this.editingProductStatus : 'OPEN',
                    variants: JSON.stringify(this.newProduct.variants),
                    shipping_rules: JSON.stringify(this.newProduct.shipping),
                    duration: Number(this.newProduct.duration), 
                    target_amount: Number(this.newProduct.targetAmount) || 0,
                    bank_info: JSON.stringify(this.newProduct.bank),
                    questions: JSON.stringify(this.newProduct.questions),
                    total_stock: calculatedStock,
                    is_pinned: this.newProduct.is_pinned,
                    end_time: endDate.toISOString()
                };

                let error;
                if(this.isEditing) {
                    const { error: e } = await supabaseClient.from('products').update(payload).eq('product_id', this.editingProductId);
                    error = e;
                } else {
                    payload.product_id = crypto.randomUUID();
                    const { error: e } = await supabaseClient.from('products').insert(payload);
                    error = e;
                }
                this.loading = false;
                if(error) alert(error.message);
                else { alert('成功'); this.view = 'admin-home'; this.fetchProducts(); }
            },
            
            updateStatus(pid, status) {
                if(!confirm(`變更為 ${status}?`)) return;
                supabaseClient.from('products').update({status: status}).eq('product_id', pid).then(() => {
                    this.fetchProducts();
                    if(this.isEditing) this.view = 'admin-home';
                });
            },
            updateOrderStatus(order) {
                supabaseClient.from('orders').update({ status: order.status }).eq('order_id', order.order_id)
                .then(e => { if(!e.error) alert('狀態更新'); });
            },
            editProduct(p) {
                if (p.status !== 'OPEN') return; 
                this.isEditing = true;
                this.editingProductId = p.product_id;
                this.editingProductStatus = p.status;
                this.newProduct = {
                    name: p.name, description: p.description, images: p.images, price: p.price, originalPrice: p.original_price,
                    stock: p.total_stock, is_pinned: p.is_pinned,
                    variants: typeof p.variants === 'string' ? JSON.parse(p.variants) : p.variants,
                    shipping: typeof p.shipping_rules === 'string' ? JSON.parse(p.shipping_rules) : p.shipping_rules,
                    duration: p.duration, targetAmount: p.target_amount,
                    bank: typeof p.bank_info === 'string' ? JSON.parse(p.bank_info) : p.bank_info || {name:'', account:''},
                    questions: typeof p.questions === 'string' ? JSON.parse(p.questions) : p.questions || []
                };
                this.previewImages = p.images ? p.images.split('\n') : [];
                this.view = 'admin-create';
            },

            checkAutoClose() {
                this.products.forEach(p => {
                    if (p.status === 'OPEN' && p.end_time && new Date(p.end_time).getTime() < Date.now()) {
                        supabaseClient.from('products').update({status: 'CLOSED'}).eq('product_id', p.product_id);
                        p.status = 'CLOSED';
                    }
                });
            },
            getCountdown(endTimeStr) {
                if(!endTimeStr) return '';
                const diff = new Date(endTimeStr).getTime() - this.now;
                if(diff <= 0) return '已結束';
                const d = Math.floor(diff / 86400000);
                return `${d}天`;
            },
            async handleFileUpload(event) {
                const files = event.target.files;
                if(!files.length) return;
                this.loading = true;
                const uploadedUrls = [];
                for(let file of files) {
                    const fileExt = file.name.split('.').pop();
                    const cleanFileName = `products/${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const { data, error } = await supabaseClient.storage.from('product-images').upload(cleanFileName, file);
                    if(!error) {
                        const { data: { publicUrl } } = supabaseClient.storage.from('product-images').getPublicUrl(cleanFileName);
                        uploadedUrls.push(publicUrl);
                    }
                }
                this.previewImages = [...this.previewImages, ...uploadedUrls];
                this.newProduct.images = this.previewImages.join('\n');
                this.loading = false;
            },
            addShippingRule(type) { 
                if(!this.newProduct.shipping.some(s=>s.name===type)) this.newProduct.shipping.push({name: type, fee: null, limit: null}); 
            },
            addVariant() { this.newProduct.variants.push({name:'', price:'', stock:''}); },
            addQuestion() { this.newProduct.questions.push({ title: '', required: true }); }, 
            updateBankInfo() { this.newProduct.bank.name = this.selectedBankName; },
            
            goToAdmin() { 
                const creds = localStorage.getItem('adminCreds'); 
                if (creds) { this.view = 'admin-home'; this.loadAllData(); } else { this.view = 'admin-login'; }
            },
            async adminLogin() {
                this.loading = true;
                const { data } = await supabaseClient.from('shops').select('*').eq('email', this.loginForm.email).eq('password', this.loginForm.password).maybeSingle();
                this.loading = false;
                if(data) { 
                    localStorage.setItem('adminCreds', JSON.stringify(data));
                    this.currentShopId = data.shop_id;
                    this.view = 'admin-home'; 
                    this.loadAllData();
                } 
                else { alert('帳號或密碼錯誤'); }
            },
            async registerShop() {
                if(!this.registerForm.shop_id || !this.registerForm.email || !this.registerForm.password) return alert('請填寫完整');
                this.loading = true;
                const { error } = await supabaseClient.from('shops').insert(this.registerForm);
                this.loading = false;
                if(error) alert('註冊失敗'); else { alert('註冊成功'); this.authMode = 'login'; }
            },
            async resetPassword() {
                if(!this.resetFormModel.email || !this.resetFormModel.password) return alert('請填寫完整');
                this.loading = true;
                const { error } = await supabaseClient.from('shops').update({ password: this.resetFormModel.password }).eq('email', this.resetFormModel.email);
                this.loading = false;
                if(error) alert('重設失敗'); else { alert('密碼已更新'); this.authMode = 'login'; }
            },
            shareLink() {
                let url = `${window.location.origin}${window.location.pathname}?shop_id=${this.currentShopId}`;
                navigator.clipboard.writeText(url).then(() => alert('已複製連結'));
            },
            logout() {
                localStorage.removeItem('adminCreds');
                this.currentShopId = 'S001';
                this.view = 'shop';
                this.loadAllData();
                alert('已登出商家');
            },
            loginBuyer() { this.view = 'buyer-login'; },
            
            openProduct(p) { this.selectedProduct = p; this.orderForm = { variant: '', qty: 1 }; this.view = 'product'; window.scrollTo(0,0); },
            goBack() { 
                if(this.view === 'product') this.view = 'shop';
                else if(this.view === 'cart') this.view = 'shop';
                else if(this.view === 'checkout_fill') this.view = 'cart';
                else if(this.view.includes('admin')) this.view = 'admin-home';
                else if(this.view.includes('buyer')) this.view = 'shop';
                else this.view = 'shop';
            },
            addToCart() {
                const currentStock = this.currentVariantStock;
                if (this.orderForm.qty > currentStock) return alert('庫存不足');
                if(this.selectedProduct.variants.length > 0 && !this.orderForm.variant) return alert('請選擇規格');
                let finalP = this.selectedProduct.price;
                if(this.orderForm.variant) {
                    const v = this.selectedProduct.variants.find(v => v.name === this.orderForm.variant);
                    if(v && v.price) finalP += parseInt(v.price);
                }
                this.cart.push({ ...this.selectedProduct, variant: this.orderForm.variant, qty: this.orderForm.qty, finalPrice: finalP, stock: currentStock });
                alert('已加入');
            },
            async submitOrder() {
                if(!this.checkoutForm.name || !this.checkoutForm.phone || !this.checkoutForm.store) return alert('資訊不完整');
                this.loading = true;
                const orderData = {
                    order_id: crypto.randomUUID(), 
                    shop_id: this.currentShopId,
                    buyer_id: this.buyerProfile ? this.buyerProfile.buyer_id : null,
                    customer_name: this.checkoutForm.name, 
                    total_amount: this.cartTotal,
                    status: 'PENDING',
                    items: JSON.stringify(this.cart),
                    receiver_name: this.checkoutForm.name,
                    receiver_phone: this.checkoutForm.phone,
                    store_name: this.checkoutForm.store,
                    ship_method: this.checkoutForm.method,
                    note: this.checkoutForm.note
                };
                const { error } = await supabaseClient.from('orders').insert(orderData);
                this.loading = false;
                if(!error) { alert('訂單已送出'); this.cart=[]; this.view='shop'; }
                else { alert('失敗: ' + error.message); }
            },
            exportToExcel() {
                if(this.adminOrderList.length === 0) return alert('無訂單');
                let csv = "\uFEFF訂單號,姓名,電話,金額\n";
                this.adminOrderList.forEach(o => csv += `${o.order_id},${o.receiver_name},${o.receiver_phone},${o.total_amount}\n`);
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                link.download = `orders_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            },
            
            // VIP
            async fetchLevelConfigs() { const { data } = await supabaseClient.from('level_config').select('*').order('level_id'); this.levelConfigs = data || []; },
            async fetchAllShops() { const { data } = await supabaseClient.from('shops').select('*').order('created_at'); this.allShops = data || []; },
            async updateShopLevel(shop) { await supabaseClient.from('shops').update({ level: shop.level }).eq('shop_id', shop.shop_id); alert(`更新成功`); },
            async saveLevelConfigs() { for (const config of this.levelConfigs) { await supabaseClient.from('level_config').upsert(config); } alert('權限已儲存'); },
        }
    }).mount('#app');
  </script>
</body>
</html>