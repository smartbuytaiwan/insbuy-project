<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>æ‹æ‹è³¼ InsBuy (Local Dev)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    [v-cloak] { display: none; }
    body { background-color: #F3F4F6; font-family: 'Noto Sans TC', sans-serif; color: #1F2937; padding-bottom: env(safe-area-inset-bottom); }
    :root { --primary-red: #CE272D; }
    .btn-red { background-color: var(--primary-red); color: white; border-radius: 8px; padding: 14px; font-weight: 700; font-size: 16px; width: 100%; transition: all 0.2s; box-shadow: 0 4px 12px rgba(206, 39, 45, 0.3); display: flex; align-items: center; justify-content: center; }
    .btn-red:active { transform: scale(0.97); }
    .btn-red:disabled { background-color: #D1D5DB; cursor: not-allowed; opacity: 0.7; }
    .input-field { background: white; border: 1px solid #E5E7EB; padding: 0 14px; border-radius: 8px; font-size: 15px; width: 100%; transition: 0.2s; height: 48px; display: flex; align-items: center; }
    .input-field:focus { border-color: var(--primary-red); outline: none; ring: 2px solid rgba(206, 39, 45, 0.1); }
    textarea.input-field { padding: 14px; height: auto; }
    .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid #F3F4F6; margin-bottom: 16px; }
    .grid-view { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 4px; }
    .grid-view .card { margin-bottom: 0; }
    .grid-view .card-img { aspect-ratio: 1/1; }
    .icon-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px; color: #6B7280; font-size: 11px; cursor: pointer; flex: 1; transition: 0.2s; border-radius: 8px; min-width: 44px; }
    .icon-btn i { font-size: 20px; margin-bottom: 4px; }
    .icon-btn:hover { color: var(--primary-red); background-color: #FEF2F2; }
    .icon-btn.active { color: var(--primary-red); font-weight: bold; }
    .processing-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .processing-spinner { width: 50px; height: 50px; border: 4px solid #E5E7EB; border-top: 4px solid var(--primary-red); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .variant-box { display: flex; justify-content: space-between; align-items: center; border: 2px solid #E5E7EB; padding: 16px; margin-bottom: 12px; border-radius: 10px; cursor: pointer; background: white; transition: 0.1s; }
    .variant-box.active { border-color: var(--primary-red) !important; background-color: #FFF5F5 !important; box-shadow: 0 0 0 2px var(--primary-red) !important; }
    .variant-box.disabled { opacity: 0.4; pointer-events: none; background: #F9FAFB; filter: grayscale(1); }
    .variant-input-box { border: 1px solid #E5E7EB; padding: 12px; border-radius: 8px; background: #F9FAFB; margin-bottom: 10px; position: relative; }
    .sold-out-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 20; backdrop-filter: blur(1px); }
    .stamp-box { border: 6px double #D32F2F; padding: 8px 24px; transform: rotate(-15deg); border-radius: 8px; background: rgba(255,255,255,0.9); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .stamp-text { color: #D32F2F; font-size: 28px; font-weight: 900; letter-spacing: 4px; text-transform: uppercase; font-family: sans-serif; }
    .status-tag { position: absolute; top: 10px; left: 10px; background: var(--primary-red); color: white; padding: 4px 10px; font-size: 12px; font-weight: bold; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10; }
    .countdown-tag { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(206, 39, 45, 0.9); color: white; text-align: center; padding: 4px 0; font-size: 12px; font-weight: bold; z-index: 10; }
    .ship-radio-label { display: flex; align-items: center; border: 1px solid #E5E7EB; padding: 16px; border-radius: 10px; cursor: pointer; margin-bottom: 10px; transition: 0.2s; background: white; }
    .ship-radio-label:hover { border-color: #D1D5DB; }
    .ship-radio-label.selected { border-color: var(--primary-red) !important; background-color: #FFF5F5 !important; box-shadow: 0 0 0 1px var(--primary-red); }
    .radio-circle { width: 22px; height: 22px; border: 2px solid #D1D5DB; border-radius: 50%; margin-right: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.2s; }
    .ship-radio-label.selected .radio-circle { border-color: var(--primary-red); background: white; }
    .radio-dot { width: 12px; height: 12px; background-color: var(--primary-red); border-radius: 50%; display: none; }
    .ship-radio-label.selected .radio-dot { display: block; }
    .safe-pb { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
    .tab-container { display: flex; border-bottom: 1px solid #E5E7EB; background: white; position: sticky; top: 0; z-index: 40; }
    .tab-btn { flex: 1; text-align: center; padding: 14px 0; font-weight: bold; color: #9CA3AF; cursor: pointer; transition: 0.2s; font-size: 15px; }
    .tab-btn.active { color: var(--primary-red); border-bottom: 3px solid var(--primary-red); }
    .chip-btn { font-size: 13px; padding: 8px 16px; border-radius: 99px; border: 1px solid #E5E7EB; background: white; font-weight: bold; color: #4B5563; transition: 0.2s; white-space: nowrap; margin-bottom: 6px; margin-right: 6px; }
    .chip-btn:hover { border-color: var(--primary-red); color: var(--primary-red); background: #FFF5F5; }
    .progress-track { height: 8px; background-color: #F3F4F6; border-radius: 99px; overflow: hidden; margin-top: 8px; border: 1px solid #E5E7EB; }
    .progress-fill { height: 100%; background-color: var(--primary-red); border-radius: 99px; transition: width 0.8s ease; }
    .toast-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 8px; z-index: 9999; font-weight: bold; transition: opacity 0.3s; pointer-events: none; }
    .hidden { opacity: 0; }
    .header-compact { background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #F3F4F6; }
    .left-info { display: flex; flex-direction: column; align-items: flex-start; }
    .left-info h1 { font-size: 22px; font-weight: 900; color: #1F2937; margin-bottom: 4px; cursor: pointer; }
    .left-info .share-btn { font-size: 13px; color: #9CA3AF; cursor: pointer; display: inline-flex; align-items: center; transition: 0.2s; }
    .left-info .share-btn:hover { color: #CE272D; }
    .right-logo { width: 70px; height: 70px; background-color: #F9FAFB; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #E5E7EB; font-size: 28px; font-weight: 900; color: #D1D5DB; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .right-logo img { width: 100%; height: 100%; object-fit: cover; }
    .admin-img-preview { position: relative; width: 60px; height: 60px; border-radius: 8px; overflow: hidden; border: 1px solid #E5E7EB; }
    .admin-img-preview img { width: 100%; height: 100%; object-fit: cover; }
    .admin-img-remove { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: white; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
    .thumb-grid { display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; padding-bottom: 5px; }
    .thumb-item { width: 60px; height: 60px; border-radius: 8px; overflow: hidden; border: 2px solid transparent; cursor: pointer; flex-shrink: 0; }
    .thumb-item.active { border-color: var(--primary-red); }
    .thumb-item img { width: 100%; height: 100%; object-fit: cover; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-body { overflow-y: auto; flex: 1; margin: 16px 0; font-size: 14px; line-height: 1.6; color: #4B5563; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative shadow-2xl flex flex-col bg-[#F8F9FA]">
    
    <div v-if="showTermsModal" class="modal-overlay" @click.self="showTermsModal=false">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800">å•†å®¶æœƒå“¡æ¢æ¬¾</h3>
            <div class="modal-body">
                <div v-if="!termsContent">è¼‰å…¥ä¸­...</div>
                <div v-else>{{ termsContent }}</div>
            </div>
            <button @click="showTermsModal=false" class="btn-red">æˆ‘å·²äº†è§£</button>
        </div>
    </div>

    <div v-if="isBanned" class="fixed inset-0 bg-white z-[1000] flex flex-col items-center justify-center text-center p-8">
        <i class="fa-solid fa-ban text-6xl text-red-500 mb-6"></i>
        <h1 class="text-3xl font-black text-gray-800 mb-2">å¸³è™Ÿå·²åœæ¬Š</h1>
        <p class="text-gray-500 mb-8">æ­¤å•†åº—ç›®å‰ç„¡æ³•ä½¿ç”¨ï¼Œè«‹è¯ç¹«å¹³å°ç®¡ç†å“¡ã€‚</p>
        <button @click="logout" class="btn-red w-auto px-8">ç™»å‡º</button>
    </div>

    <div id="toast" class="toast-msg hidden"></div>

    <div v-if="submitting" class="processing-overlay">
        <div class="processing-spinner"></div>
        <h2 class="text-xl font-black text-gray-800">åŠªåŠ›æ¬è²¨ä¸­... ğŸ“¦</h2>
        <p class="text-sm text-gray-500 mt-2">è«‹ç¨å€™ç‰‡åˆ»</p>
    </div>

    <div v-if="view!=='admin-login' && view!=='register' && view!=='forgot-password'" class="header-compact">
        <div class="left-info">
            <h1 @click="goToOfficialShop">{{ shopName || 'æ‹æ‹è³¼ InsBuy' }}</h1>
            <div @click="copyShopLink" class="share-btn"><i class="fa-solid fa-share-nodes mr-1"></i>åˆ†äº«è³£å ´</div>
        </div>
        <div class="right-logo" @click="goToOfficialShop">
            <img v-if="shopLogo" :src="shopLogo" @error="$event.target.src='https://placehold.co/100?text=Logo'">
            <span v-else>{{ (shopName || 'æ‹').charAt(0) }}</span>
        </div>
    </div>

    <header v-if="view!=='admin-login' && view!=='register' && view!=='forgot-password'" class="bg-white sticky top-0 z-50 shadow-sm border-b border-gray-100">
        <div class="flex justify-between items-center px-2 py-2">
             <button @click="handleNav('inquiry')" :class="['icon-btn', view==='inquiry'?'active':'']">
                 <i class="fa-solid fa-magnifying-glass"></i><span>è¨‚å–®æŸ¥è©¢</span>
             </button>
             <button v-if="view==='shop'" @click="isGridView = !isGridView" class="icon-btn">
                <i :class="isGridView ? 'fa-solid fa-list' : 'fa-solid fa-table-cells-large'"></i>
                <span>{{ isGridView ? 'åˆ‡æ›è¦–åœ–' : 'åˆ‡æ›è¦–åœ–' }}</span>
             </button>
             <button v-else @click="handleNav('shop')" class="icon-btn">
                <i class="fa-solid fa-store"></i><span>å›è³£å ´</span>
             </button>
             <button @click="handleNav('cart')" :class="['icon-btn relative', view==='cart'?'active':'']">
                <i class="fa-solid fa-cart-shopping"></i>
                <span v-if="cartTotalQty > 0" class="absolute top-0 right-1 bg-red-600 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full border border-white">{{ cartTotalQty }}</span>
                <span>è³¼ç‰©è»Š</span>
             </button>
             <button @click="goToAdmin" :class="['icon-btn', view.includes('admin')?'active':'']">
                 <i class="fa-solid fa-user-gear"></i>
                 <span>å¾Œå°ç®¡ç†</span>
             </button>
             <button @click="goToRegister" :class="['icon-btn', view==='register'?'active':'']">
                 <i class="fa-solid fa-store"></i><span>è¨»å†Šå•†å®¶</span>
             </button>
        </div>
        <div v-if="view === 'admin'" class="bg-gray-800 text-white px-4 py-2 flex justify-between items-center text-xs">
             <span>ç®¡ç†å“¡æ¨¡å¼ (Lv.{{ adminLevel }})</span>
             <div class="flex gap-3">
                 <button @click="logout" class="hover:text-red-400 font-bold">ç™»å‡º</button>
             </div>
        </div>
    </header>

    <div v-if="view === 'inquiry'" class="p-6 bg-white min-h-screen">
        <h2 class="text-2xl font-black mb-6 text-gray-800">è¨‚å–®æŸ¥è©¢</h2>
        <div class="card p-6 border-0 shadow-lg">
            <input v-model="inquiryPhone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" class="input-field mb-4 text-center text-lg">
            <button @click="checkOrders" class="btn-red shadow-lg">æŸ¥è©¢è¨‚å–®</button>
        </div>
        <div v-if="inquiryResults.length > 0" class="space-y-4 mt-6">
            <div v-for="order in inquiryResults" :key="order.orderId" class="card p-5 border border-gray-100 shadow-sm relative overflow-hidden">
                 <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                     <span class="font-bold text-gray-800">{{ order.date }}</span>
                     <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold">{{ order.status }}</span>
                 </div>
                 <div class="space-y-2 mb-3">
                     <div v-for="(item, i) in order.items" :key="i" class="text-sm text-gray-600 flex justify-between">
                         <span>{{ item.name }} {{ item.variant ? '- '+item.variant : '' }} x {{ item.qty }}</span>
                         <span class="font-bold text-gray-800">\${{ item.price }}</span>
                     </div>
                 </div>
                 <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                     <span class="text-xs text-gray-400">è¨‚å–®ç·¨è™Ÿ: {{ order.orderId }}</span>
                     <span class="text-xl font-black text-red-600">\${{ formatNumber(order.total) }}</span>
                 </div>
            </div>
        </div>
        <div v-else-if="searched && inquiryResults.length === 0" class="text-center text-gray-400 mt-10">
            <i class="fa-solid fa-box-open text-4xl mb-2"></i>
            <p>æŸ¥ç„¡è¨‚å–®è³‡æ–™</p>
        </div>
    </div>

    <div v-if="view === 'shop'" class="flex-grow flex flex-col min-h-screen pb-32">
        <div class="tab-container">
            <div @click="shopTab='active'" :class="['tab-btn', shopTab==='active'?'active':'']">ğŸ”¥ ç†±éŠ·åœ˜è³¼</div>
            <div @click="shopTab='history'" :class="['tab-btn', shopTab==='history'?'active':'']">ğŸ•’ æ­·å²åœ˜è³¼</div>
        </div>
        <div class="p-4 overflow-y-auto">
            <div v-if="loading" class="space-y-6 mt-2">
                 <div v-for="n in 3" :key="n" class="card"><div class="aspect-video skeleton w-full"></div><div class="p-5"><div class="skeleton h-6 w-3/4 mb-4"></div><div class="skeleton h-8 w-1/3 mb-4"></div></div></div>
            </div>
            <div v-else>
                <div v-if="filteredProducts.length === 0" class="text-center mt-24 text-gray-400">
                    <i class="fa-solid fa-fire-flame-curved text-4xl mb-3 opacity-20"></i><p class="font-bold">ç›®å‰æ²’æœ‰ç›¸é—œåœ˜è³¼</p>
                </div>
                <div :class="isGridView ? 'grid-view' : 'space-y-6'">
                    <div v-for="item in filteredProducts" :key="item.ProductID" @click="openProductDetail(item)" class="card cursor-pointer group hover:shadow-xl transition duration-300">
                        <div class="relative w-full bg-gray-100 overflow-hidden border-b border-gray-100" :class="isGridView ? 'card-img' : 'aspect-video'">
                            <img v-if="item.imagesList.length > 0" :src="item.imagesList[0]" @error="$event.target.src='https://placehold.co/300x300?text=No+Image'" class="w-full h-full object-cover transition duration-700 group-hover:scale-105">
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-regular fa-image text-4xl"></i></div>
                            <div class="status-tag">HOT</div>
                            <div v-if="item.remainingStr" class="countdown-tag"><i class="fa-regular fa-clock mr-1"></i>å‰© {{ item.remainingStr }}</div>
                            <div v-if="item.TotalStock <= 0" class="sold-out-overlay"><div class="stamp-box"><div class="stamp-text">å·²å”®å®Œ</div></div></div>
                            <div v-else-if="item.Status === 'CLOSED' || item.isExpired" class="sold-out-overlay"><div class="stamp-box"><div class="stamp-text">å·²çµæŸ</div></div></div>
                        </div>
                        <div class="p-4 relative">
                            <h3 :class="['font-bold text-gray-900 leading-snug line-clamp-2', isGridView ? 'text-sm h-10 mb-2' : 'text-xl mb-3']">{{ item.ProductName }}</h3>
                            <div v-if="!isGridView">
                                 <div v-if="item.TargetAmount > 0" class="mb-4">
                                     <div class="flex justify-between text-xs font-bold text-gray-500 mb-1">
                                         <span>é”æˆç‡ {{ getProgress(item) }}%</span>
                                         <span class="text-red-600">å·²éŠ· \${{ formatNumber(item.CurrentAmount || 0) }}</span>
                                     </div>
                                     <div class="progress-track"><div class="progress-fill" :style="{width: Math.min(getProgress(item), 100) + '%'}"></div></div>
                                 </div>
                                 <div class="flex justify-between items-end mt-2">
                                     <div class="flex items-baseline gap-2">
                                         <span class="text-xs text-gray-400 line-through">åŸåƒ¹\${{ item.OriginalPrice }}</span>
                                         <span class="text-3xl font-black text-red-600 tracking-tight">\${{ item.Price }}</span>
                                     </div>
                                     <button class="bg-red-600 text-white text-sm px-6 py-2 rounded-full font-bold shadow-md hover:bg-red-700 transition">ç«‹å³æ¶è³¼</button>
                                 </div>
                            </div>
                            <div v-if="isGridView">
                                <div class="text-[10px] text-gray-500 mb-1 font-bold">å·²éŠ· \${{ formatNumber(item.CurrentAmount || 0) }}</div>
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-gray-400 line-through" v-if="item.OriginalPrice > item.Price">åŸåƒ¹\${{ item.OriginalPrice }}</span>
                                    <span class="text-xl font-black text-red-600">\${{ item.Price }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="view === 'product' && selectedProduct" class="flex-grow pb-32 overflow-y-auto bg-white">
        <div class="w-full bg-gray-100 relative">
            <img :src="currentPreviewImage || selectedProduct.imagesList[0]" @error="$event.target.src='https://placehold.co/400x400?text=No+Image'" class="w-full h-auto object-contain max-h-[500px] mx-auto">
        </div>
        <div class="p-6">
            <div v-if="selectedProduct.imagesList.length > 1" class="thumb-grid mb-4">
                <div v-for="(img, idx) in selectedProduct.imagesList" :key="idx" 
                     @click="currentPreviewImage = img"
                     :class="['thumb-item', currentPreviewImage === img ? 'active' : '']">
                    <img :src="img" class="w-full h-full object-cover">
                </div>
            </div>
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-black text-gray-900 leading-snug flex-1">{{ selectedProduct.ProductName }}</h2>
                <button @click="copyProductLink(selectedProduct)" class="ml-4 text-gray-400 hover:text-red-600 text-2xl transition"><i class="fa-solid fa-share-nodes"></i></button>
            </div>
            <div class="flex items-baseline gap-3 mb-8 border-b border-gray-100 pb-6">
                <span class="text-4xl font-black text-red-600">\${{ currentPrice }}</span>
                <span v-if="selectedProduct.OriginalPrice" class="text-lg text-gray-400 line-through">å®šåƒ¹ \${{ selectedProduct.OriginalPrice }}</span>
            </div>
            <div class="mb-8">
                <h3 class="text-base font-bold text-gray-900 mb-3 flex items-center"><span class="w-1 h-6 bg-gray-800 mr-2 rounded-full"></span>å°ˆæ¡ˆå…§å®¹</h3>
                <div class="text-gray-600 text-base whitespace-pre-wrap leading-relaxed bg-gray-50 p-4 rounded-xl">{{ selectedProduct.Description }}</div>
            </div>
            <div v-if="selectedProduct.variants.length > 0" class="mb-8">
                <h3 class="text-base font-bold text-gray-900 mb-3 flex items-center"><span class="w-1 h-6 bg-red-600 mr-2 rounded-full"></span>é¸æ“‡è¦æ ¼</h3>
                <div v-for="(v, idx) in selectedProduct.variants" :key="idx" @click="selectVariant(v, idx)" 
                     :class="['variant-box', orderForm.variantIdx === idx ? 'active' : '', parseInt(v.stock) <= 0 ? 'disabled' : '']"
                     :style="orderForm.variantIdx === idx ? 'border: 2px solid #CE272D !important; background-color: #FFF5F5 !important;' : ''">
                    <span class="font-bold text-gray-800 text-lg">{{ v.name }} <span v-if="v.isVip" class="text-[10px] bg-yellow-400 text-white px-2 py-0.5 rounded ml-2 font-bold">VIP</span></span>
                    <div class="text-right">
                        <span class="text-red-600 font-bold block text-xl">\${{ v.price }}</span>
                        <span class="text-xs text-gray-400 block mt-1">{{ parseInt(v.stock) > 0 ? 'å‰©é¤˜ '+v.stock : 'å·²å”®å®Œ' }}</span>
                    </div>
                </div>
            </div>
             <div class="flex items-center justify-between border-t border-gray-100 pt-6">
                <label class="font-bold text-gray-900 text-lg">è³¼è²·æ•¸é‡</label>
                <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden h-12 w-48 relative z-10 shadow-sm">
                    <button type="button" @click.stop="decreaseQty" class="w-14 h-full bg-gray-50 hover:bg-gray-100 border-r border-gray-300 font-bold text-gray-500 text-xl flex items-center justify-center cursor-pointer transition active:bg-gray-200">-</button>
                    <input v-model.number="orderForm.qty" @change="validateQty" class="w-full text-center outline-none font-bold text-xl h-full bg-white text-gray-800">
                    <button type="button" @click.stop="increaseQty" class="w-14 h-full bg-gray-50 hover:bg-gray-100 border-l border-gray-300 font-bold text-gray-500 text-xl flex items-center justify-center cursor-pointer transition active:bg-gray-200">+</button>
                </div>
            </div>
        </div>
        <div class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-100 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-50 safe-pb">
            <button @click="addToCart(false)" :disabled="isOutOfStock" class="btn-red shadow-xl">åŠ å…¥è³¼ç‰©è»Š</button>
        </div>
    </div>

    <div v-if="view === 'cart'" class="flex-grow bg-[#F3F4F6] p-4 pb-32 overflow-y-auto">
        <h2 class="text-2xl font-black mb-4 text-gray-800 px-1">è³¼ç‰©è»Š</h2>
        <div v-if="cart.length > 0" class="space-y-4">
            <div v-for="(item, idx) in cart" :key="idx" class="card p-4 flex gap-4 relative border-l-4 border-red-600">
                <img :src="item.image || 'https://placehold.co/300x300'" class="w-20 h-20 object-cover rounded-lg border border-gray-100">
                <div class="flex-1">
                    <div class="font-bold text-gray-900 text-base mb-1">{{ item.productName }}</div>
                    <div class="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-1 rounded mb-2">{{ item.variantName }} x {{ item.qty }}</div>
                    <div v-if="item.answers" class="text-xs text-blue-600 bg-blue-50 p-2 rounded mb-2">
                        <div v-for="(ans, key) in item.answers" :key="key">{{key}}: {{ans}}</div>
                    </div>
                    <div class="text-red-600 font-black text-xl">\${{ item.price * item.qty }}</div>
                </div>
                <button @click="removeFromCart(idx)" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 p-2"><i class="fa-solid fa-trash-can text-lg"></i></button>
            </div>
            
            <div class="card p-6 space-y-5">
                 <h3 class="font-bold text-gray-900 text-lg border-b pb-3 mb-2">æ”¶ä»¶è³‡è¨Š</h3>
                 <div>
                     <label class="block text-sm font-bold text-gray-600 mb-3">é‹é€æ–¹å¼</label>
                     <div v-if="availableShippingOptions.length > 0">
                         <div v-for="opt in availableShippingOptions" @click="selectShippingMethod(opt)" 
                              :class="['ship-radio-label', checkoutForm.shippingMethodName===opt.name && !checkoutForm.isFaceToFace ? 'selected' : '']">
                              <div class="radio-circle"><div class="radio-dot"></div></div>
                              <div class="flex-1"><div class="flex justify-between font-bold text-gray-800"><span>{{ opt.name }}</span><span>\${{ opt.totalFee }}</span></div><div class="text-xs text-gray-500 mt-1">{{ opt.ruleDesc }}</div></div>
                         </div>
                     </div>
                     <div v-else class="text-sm text-red-500 bg-red-50 p-3 rounded-lg border border-red-100">âš ï¸ æ­¤å•†å“æš«ç„¡é‹é€é¸é …ï¼Œè«‹è¯ç¹«è³£å®¶ã€‚</div>
                     
                     <div v-if="hasFaceToFace" @click="selectShippingMethod({name:'é¢äº¤'})"
                          :class="['ship-radio-label', checkoutForm.isFaceToFace ? 'selected' : '']">
                          <div class="radio-circle"><div class="radio-dot"></div></div>
                          <div class="flex-1"><div class="font-bold text-gray-800">é¢äº¤è‡ªå– ($0)</div><div class="text-xs text-gray-500 mt-1">åœ°é»: {{ faceToFaceAddress }}</div></div>
                     </div>
                 </div>
                 
                 <div v-if="checkoutForm.isFaceToFace">
                     <label class="block text-sm font-bold text-gray-600 mb-2">é¸æ“‡é¢äº¤æ™‚é–“</label>
                     <input type="datetime-local" v-model="checkoutForm.meetTime" class="input-field">
                 </div>
                 
                 <div class="space-y-3">
                    <input v-model="checkoutForm.name" class="input-field" placeholder="çœŸå¯¦å§“å">
                    <input v-model="checkoutForm.phone" class="input-field" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                    <input v-if="!checkoutForm.isFaceToFace" v-model="checkoutForm.address" class="input-field" placeholder="æ”¶ä»¶åœ°å€ / é–€å¸‚åç¨±">
                 </div>
                 
                 <div class="pt-6 border-t border-gray-100">
                    <h3 class="font-bold text-gray-900 text-lg mb-4">ä»˜æ¬¾è³‡è¨Š</h3>
                    <div v-if="uniqueBankInfo && uniqueBankInfo.account" class="bg-yellow-50 p-5 border border-yellow-200 rounded-xl mb-5 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-bold text-yellow-800 flex items-center"><i class="fa-solid fa-building-columns mr-2"></i>{{ uniqueBankInfo.name || 'éŠ€è¡Œè½‰å¸³' }}</span>
                            <button @click="copyText(uniqueBankInfo.account)" class="text-xs bg-white border border-yellow-300 px-3 py-1.5 rounded-full text-yellow-700 hover:bg-yellow-100 font-bold transition">è¤‡è£½å¸³è™Ÿ</button>
                        </div>
                        <div class="font-mono text-2xl font-black text-gray-800 tracking-wider text-center py-2">{{ uniqueBankInfo.account }}</div>
                        <div class="text-center text-xs text-yellow-600 mt-1">è«‹è½‰å¸³å¾Œå¡«å¯«ä¸‹æ–¹å¾Œäº”ç¢¼</div>
                    </div>
                    <div v-else class="text-sm text-gray-400 mb-4 bg-gray-50 p-3 rounded text-center">è³£å®¶æœªè¨­å®šåŒ¯æ¬¾å¸³è™Ÿï¼Œè«‹ç›´æ¥è¯ç¹«è³£å®¶ã€‚</div>
                    
                    <input v-model="checkoutForm.last5" class="input-field text-center tracking-[0.5em] font-bold text-xl h-14" maxlength="5" placeholder="è¼¸å…¥åŒ¯æ¬¾å¾Œäº”ç¢¼">
                </div>

                <div v-if="cart.some(i => i.questions && i.questions.length > 0)" class="pt-6 border-t border-gray-100">
                     <h3 class="font-bold text-gray-900 text-lg mb-4">è³£å®¶æå• (è«‹å¡«å¯«)</h3>
                     <div v-for="(item, idx) in cart" :key="idx">
                         <div v-if="item.questions && item.questions.length > 0" class="bg-blue-50 p-4 rounded-xl mb-3">
                             <div class="text-sm font-bold text-blue-800 mb-2">{{ item.productName }}</div>
                             <div v-for="(q, qIdx) in item.questions" :key="qIdx" class="mb-2">
                                 <label class="block text-xs font-bold text-gray-700 mb-1">{{ q.title }} <span v-if="q.required" class="text-red-500">*</span></label>
                                 <input v-model="item.answers[q.title]" class="input-field h-8 text-sm" :placeholder="q.required ? 'å¿…å¡«' : 'é¸å¡«'">
                             </div>
                         </div>
                     </div>
                </div>

                <textarea v-model="checkoutForm.note" rows="2" class="input-field" placeholder="å‚™è¨» (é¸å¡«)"></textarea>
            </div>
            <div class="card p-6 space-y-3 text-sm font-medium">
                <div class="flex justify-between text-gray-500"><span>å°è¨ˆ</span><span>\${{ cartSubTotal }}</span></div>
                <div class="flex justify-between text-gray-500"><span>é‹è²»</span><span>\${{ checkoutForm.isFaceToFace ? 0 : currentShippingTotal }}</span></div>
                <div class="flex justify-between text-2xl font-black text-gray-900 border-t border-gray-200 pt-4 mt-2"><span>ç¸½è¨ˆ</span><span class="text-red-600">\${{ cartFinalTotal }}</span></div>
            </div>
        </div>
        <div v-else class="text-center py-32 text-gray-400">
            <i class="fa-solid fa-cart-arrow-down text-6xl mb-6 opacity-20"></i><p class="font-bold text-lg">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
            <button @click="view='shop'" class="mt-8 text-red-600 font-bold underline text-lg">å»é€›é€›</button>
        </div>
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-5 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-50 max-w-md mx-auto safe-pb">
            <button @click="submitOrder" :disabled="cart.length === 0" class="w-full btn-red py-4 shadow-xl disabled:opacity-50 text-lg">ç¢ºèªçµå¸³ â€¢ \${{ cartFinalTotal }}</button>
        </div>
    </div>

    <div v-if="view === 'admin'" class="p-4 bg-[#F3F4F6] min-h-screen pb-24">
        <div class="bg-white p-5 rounded-xl shadow-sm mb-6 border border-gray-200">
            <h3 class="font-bold text-gray-800 border-b pb-2 mb-4 flex justify-between items-center">
                <span>å•†åº—è¨­å®š</span>
                <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold border border-yellow-300">Lv.{{ adminLevel }}</span>
            </h3>
            <div class="flex gap-4 items-start">
                <div class="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 border flex items-center justify-center overflow-hidden">
                    <img v-if="shopLogo" :src="shopLogo" @error="$event.target.src='https://placehold.co/100?text=Logo'" class="w-full h-full object-cover">
                    <span v-else class="text-2xl text-gray-300 font-bold">{{ (shopName||'').charAt(0) }}</span>
                </div>
                <div class="flex-1 space-y-3">
                    <input v-model="shopName" class="input-field h-10" placeholder="å•†åº—åç¨±">
                    <label class="text-xs bg-gray-800 text-white px-3 py-2 rounded cursor-pointer inline-block hover:bg-gray-700">
                        <i class="fa-solid fa-camera mr-1"></i>æ›´æ› Logo
                        <input type="file" accept="image/*" class="hidden" @change="handleLogoUpload">
                    </label>
                    <button @click="updateShopSettings" class="text-xs bg-red-600 text-white px-3 py-2 rounded ml-2 hover:bg-red-700">å„²å­˜è¨­å®š</button>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                 <div class="text-xs text-gray-400">å•†åº— ID: {{ currentShopId }}</div>
                 <div class="flex gap-2">
                     <button v-if="currentShopId === 'S001'" @click="toggleRegistration" class="text-xs bg-blue-600 text-white px-2 py-1 rounded">{{ registrationStatus === 'OPEN' ? 'ğŸŸ¢ è¨»å†Šä¸­' : 'ğŸ”´ åœè¨»å†Š' }}</button>
                     <button @click="logout" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded hover:bg-red-50">ç™»å‡º</button>
                 </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="card p-5 text-center mb-0 shadow-sm border-0"><div class="text-xs text-gray-500 font-bold mb-2">ä»Šæ—¥éŠ·å”®</div><div class="text-3xl font-black text-gray-800">\${{ formatNumber(stats.daily) }}</div></div>
            <div class="card p-5 text-center mb-0 shadow-sm border-0"><div class="text-xs text-gray-500 font-bold mb-2">æœ¬æœˆéŠ·å”®</div><div class="text-3xl font-black text-red-600">\${{ formatNumber(stats.monthly) }}</div></div>
        </div>
        
        <button @click="isEditing=true; resetForm()" class="btn-red mb-6 shadow-lg w-full py-4"><i class="fa-solid fa-plus mr-2"></i>æ–°å¢åœ˜è³¼</button>
        
        <div v-if="isEditing" class="space-y-6" id="adminForm">
             <div v-if="limitReached && !editingProductId" class="bg-red-50 border-l-4 border-red-500 p-4 rounded text-sm text-red-700 mb-4"><p class="font-bold mb-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i> å·²é”é–‹åœ˜ä¸Šé™</p><p>è«‹å…ˆçµæŸç¾æœ‰åœ˜è³¼ï¼Œæˆ–æ˜¯ <a href="https://groupbuy.smartbuytaiwan.workers.dev/?shopId=S001" target="_blank" class="underline font-bold">å‡ç´šæ–¹æ¡ˆ</a>ã€‚</p></div>
             <fieldset :disabled="limitReached && !editingProductId" class="space-y-5 group-disabled:opacity-50 group-disabled:pointer-events-none">
                 <div class="card p-6 space-y-4">
                     <h3 class="font-bold text-gray-800 border-b pb-2">åŸºæœ¬è³‡è¨Š</h3>
                     <input v-model="newProduct.name" placeholder="å•†å“åç¨±" class="input-field">
                     <textarea v-model="newProduct.description" rows="4" placeholder="å•†å“æè¿°" class="input-field"></textarea>
                     <textarea v-model="newProduct.images" rows="3" placeholder="åœ–ç‰‡é€£çµ (ä¸€è¡Œä¸€å¼µ)" class="input-field font-mono text-xs"></textarea>
                     <label class="btn-red bg-gray-800 text-white text-sm py-3 w-auto inline-block cursor-pointer px-6 rounded-full"><i class="fa-solid fa-camera mr-2"></i>ä¸Šå‚³åœ–ç‰‡ (å¯å¤šé¸)<input type="file" multiple accept="image/*" class="hidden" @change="handleFileUpload"></label>
                     <div v-if="newProduct.images" class="flex flex-wrap gap-2 mt-2">
                         <div v-for="(img, i) in newProduct.images.split('\\n')" :key="i" class="admin-img-preview">
                             <img :src="img" @error="$event.target.style.display='none'">
                             <div class="admin-img-remove" @click="removeImage(i)"><i class="fa-solid fa-times"></i></div>
                         </div>
                     </div>
                 </div>

                 <div class="card p-6 space-y-4">
                     <h3 class="font-bold text-gray-800 border-b pb-2">åƒ¹æ ¼èˆ‡è¦æ ¼</h3>
                     <div class="grid grid-cols-2 gap-4"><input v-model="newProduct.price" type="number" placeholder="ç‰¹åƒ¹" class="input-field text-red-600 font-bold"><input v-model="newProduct.originalPrice" type="number" placeholder="åŸåƒ¹" class="input-field"></div>
                     <div class="border-t pt-4 mt-2">
                         <div class="flex justify-between items-center mb-3"><label class="text-sm font-bold text-gray-600">è¦æ ¼è¨­å®š</label><button @click="addVariant" class="text-xs bg-gray-100 px-3 py-1 rounded border hover:bg-gray-200">+ æ–°å¢è¦æ ¼</button></div>
                         <div v-for="(v, idx) in newProduct.variants" :key="idx" class="variant-input-box relative">
                             <i @click="newProduct.variants.splice(idx,1)" class="fa-solid fa-times absolute top-2 right-2 text-gray-400 p-2 cursor-pointer"></i>
                             <input v-model="v.name" placeholder="è¦æ ¼åç¨±" class="input-field h-10 mb-2">
                             <div class="flex gap-2"><input v-model="v.price" type="number" placeholder="åƒ¹æ ¼" class="input-field h-10 text-center"><input v-model="v.stock" type="number" placeholder="åº«å­˜" class="input-field h-10 text-center"></div>
                         </div>
                     </div>
                 </div>
                 
                 <div class="card p-6 space-y-4">
                     <h3 class="font-bold text-gray-800 border-b pb-2">é‹é€èˆ‡é‡‘æµ</h3>
                     <div class="flex flex-wrap gap-2 mb-2">
                         <button v-for="type in ['7-11','å…¨å®¶','èŠçˆ¾å¯Œ','å®…é…','éƒµå¯„','é¢äº¤','å…¶ä»–']" 
                                 @click="addShippingRule(type)" 
                                 class="chip-btn">+ {{ type }}</button>
                     </div>
                     <div v-for="(r, idx) in newProduct.shipping" :key="idx" class="flex gap-2 mb-2 items-center bg-gray-50 p-2 rounded">
                         <input v-model="r.name" placeholder="æ–¹å¼åç¨±" class="input-field h-10 text-xs flex-1 border-0 bg-white">
                         <input v-model="r.fee" type="number" placeholder="é‹è²»" class="input-field h-10 w-20 text-center mx-1 border-0 bg-white">
                         <input v-model="r.limit" type="number" placeholder="æ•¸é‡é™åˆ¶" class="input-field h-10 w-20 text-center border-0 bg-white" title="æ¯å¹¾ä»¶æ”¶ä¸€æ¬¡é‹è²»">
                         <i @click="newProduct.shipping.splice(idx,1)" class="fa-solid fa-trash text-red-400 cursor-pointer ml-2 hover:text-red-600"></i>
                     </div>
                     <div v-if="newProduct.shipping.some(s => s.name.includes('é¢äº¤'))" class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                         <label class="block text-xs font-bold text-yellow-800 mb-1">é¢äº¤åœ°é»èªªæ˜</label>
                         <input v-model="newProduct.faceToFaceAddress" placeholder="ä¾‹å¦‚ï¼šå°åŒ—è»Šç«™ M3 å‡ºå£" class="input-field h-10 text-sm">
                     </div>
                     
                     <div class="border-t pt-4 mt-2">
                         <div class="flex gap-4 mb-4">
                             <div class="flex-1 w-1/2">
                                 <label class="block text-xs font-bold text-gray-500 mb-1">é–‹åœ˜å¤©æ•¸</label>
                                 <div class="flex gap-2">
                                     <select v-model="durationSelect" class="input-field h-10 text-sm w-full bg-white flex-1" @change="onDurationChange">
                                         <option value="1">1 å¤©</option>
                                         <option value="3">3 å¤©</option>
                                         <option value="7">7 å¤©</option>
                                         <option value="15">15 å¤©</option>
                                         <option value="30">30 å¤©</option>
                                         <option value="custom">å…¶ä»–</option>
                                     </select>
                                     <input v-if="durationSelect==='custom'" v-model="newProduct.duration" type="number" placeholder="å¤©æ•¸" class="input-field h-10 w-20 text-center">
                                 </div>
                             </div>
                             <div class="flex-1 w-1/2">
                                 <label class="block text-xs font-bold text-gray-500 mb-1">ç›®æ¨™é‡‘é¡</label>
                                 <input v-model="newProduct.targetAmount" type="number" class="input-field h-10 w-full">
                             </div>
                         </div>
                         
                         <div>
                             <label class="block text-xs font-bold text-gray-500 mb-1">æ”¶æ¬¾éŠ€è¡Œ</label>
                             <div class="flex gap-2 mb-2">
                                 <select v-model="selectedBank" @change="onBankChange" class="input-field h-10 flex-1 bg-white">
                                     <option value="" disabled>é¸æ“‡éŠ€è¡Œ</option>
                                     <option v-for="b in commonBanks" :value="b">{{ b }}</option>
                                     <option value="Other">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>
                                 </select>
                                 <input v-if="selectedBank==='Other'" v-model="newProduct.bank.name" placeholder="è¼¸å…¥éŠ€è¡Œåç¨±" class="input-field h-10 flex-1">
                             </div>
                             <input v-model="newProduct.bank.account" placeholder="éŠ€è¡Œå¸³è™Ÿ" class="input-field h-10 w-full font-mono">
                         </div>
                     </div>
                 </div>

                 <div class="card p-6 space-y-4">
                     <h3 class="font-bold text-gray-800 border-b pb-2">è³£å®¶æå• (é¸å¡«)</h3>
                     <div v-for="(q, idx) in newProduct.questions" :key="idx" class="flex gap-2 items-center bg-gray-50 p-3 rounded">
                         <input v-model="q.title" class="input-field h-10 flex-1" placeholder="å•é¡Œå…§å®¹ (å¦‚: ä½ çš„Line ID)">
                         <label class="flex items-center text-sm font-bold text-gray-600 gap-2">
                             <input type="checkbox" v-model="q.required"> å¿…å¡«
                         </label>
                         <button @click="newProduct.questions.splice(idx,1)" class="text-red-500 hover:text-red-700 ml-2"><i class="fa-solid fa-trash"></i></button>
                     </div>
                     <button @click="addQuestion" class="text-sm bg-blue-50 text-blue-600 px-4 py-2 rounded-full font-bold hover:bg-blue-100">+ æ–°å¢å•é¡Œ</button>
                 </div>

                 <button @click="saveProduct" class="btn-red w-full py-4 shadow-xl">å„²å­˜è¨­å®š</button>
                 <button @click="isEditing=false" class="w-full py-4 text-gray-500 font-bold bg-white border border-gray-300 rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
             </fieldset>
        </div>
        
        <div class="flex border-b border-gray-200 mb-4 mt-2">
            <div @click="adminTab='active'" :class="['tab-btn', adminTab==='active'?'active':'']">åœ˜è³¼ä¸­</div>
            <div @click="adminTab='ended'" :class="['tab-btn', adminTab==='ended'?'active':'']">å·²çµæŸ</div>
            <div @click="adminTab='deleted'" :class="['tab-btn', adminTab==='deleted'?'active':'']">å·²åˆªé™¤</div>
        </div>

        <div class="mt-2 space-y-3">
            <div v-for="item in adminFilteredProducts" :key="item.ProductID" class="card p-4 flex justify-between items-center mb-3">
                <div class="flex items-center gap-4"><img :src="item.imagesList[0] || 'https://placehold.co/100'" @error="$event.target.src='https://placehold.co/100'" class="w-12 h-12 rounded-lg object-cover bg-gray-100 border border-gray-100"><div class="text-sm font-bold text-gray-800 truncate w-32">{{ item.ProductName }}</div></div>
                <div class="flex gap-2"><button @click="handleEditClick(item)" class="text-xs border border-blue-200 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-50 font-bold">ç·¨è¼¯</button><button @click="handleDeleteClick(item.ProductID)" class="text-xs border border-red-200 text-red-600 px-3 py-1.5 rounded hover:bg-red-50 font-bold">åˆªé™¤</button></div>
            </div>
            <div v-if="adminFilteredProducts.length===0" class="text-center text-gray-400 py-10 text-sm">ç„¡è³‡æ–™</div>
        </div>
    </div>
    
    <div v-if="view === 'admin-login'" class="p-8 text-center bg-white min-h-screen flex flex-col justify-center">
         <h2 class="text-3xl font-black mb-8 text-gray-800">å•†å®¶ç™»å…¥</h2>
         <input v-model="loginForm.email" placeholder="Email" class="input-field mb-3 text-center">
         <input type="password" v-model="loginForm.password" placeholder="å¯†ç¢¼" class="input-field mb-4 text-center">
         <button @click="adminLogin" class="btn-red w-full mb-6 shadow-lg">ç™»å…¥</button>
         <div class="flex justify-between w-full px-4 mt-2">
             <button @click="view='forgot-password'" class="text-sm text-gray-500 hover:text-gray-800 underline">å¿˜è¨˜å¯†ç¢¼</button>
             <button @click="view='register'" class="text-sm text-gray-500 hover:text-gray-800 underline">è¨»å†Šæ–°å¸³è™Ÿ</button>
         </div>
    </div>

    <div v-if="view === 'forgot-password'" class="p-8 text-center bg-white min-h-screen flex flex-col justify-center">
        <h2 class="text-2xl font-black mb-6 text-gray-800">é‡è¨­å¯†ç¢¼</h2>
        <p class="text-gray-500 text-sm mb-6">è«‹è¼¸å…¥æ‚¨è¨»å†Šçš„ Emailï¼Œæˆ‘å€‘æœƒå°‡å¯†ç¢¼å¯„çµ¦æ‚¨ã€‚</p>
        <input v-model="loginForm.email" placeholder="Email" class="input-field mb-6 text-center">
        <button @click="resetPassword" class="btn-red w-full mb-4">å¯„é€å¯†ç¢¼</button>
        <button @click="view='admin-login'" class="text-sm text-gray-400 hover:text-gray-600">è¿”å›ç™»å…¥</button>
    </div>

    <div v-if="view === 'register'" class="p-8 text-center bg-white min-h-screen flex flex-col justify-center">
        <h2 class="text-3xl font-black mb-8 text-gray-800">è¨»å†Šå•†å®¶</h2>
        <input v-model="regForm.shopName" class="input-field text-center mb-3" placeholder="è³£å ´åç¨±">
        <input v-model="regForm.company" class="input-field text-center mb-3" placeholder="å…¬å¸åç¨± (é¸å¡«)">
        <input v-model="regForm.taxId" class="input-field text-center mb-3" placeholder="çµ±ä¸€ç·¨è™Ÿ (é¸å¡«)">
        <input v-model="regForm.phone" class="input-field text-center mb-3" placeholder="é›»è©±è™Ÿç¢¼ (å¿…å¡«)">
        <input v-model="regForm.email" class="input-field text-center mb-3" placeholder="Email">
        <input v-model="regForm.password" type="password" class="input-field text-center mb-3" placeholder="å¯†ç¢¼">
        <div class="flex items-center justify-center gap-2 mb-4 text-sm text-gray-600">
            <input type="checkbox" v-model="regForm.agreeTerms" id="agreeTerms">
            <label for="agreeTerms">æˆ‘å·²é–±è®€ä¸¦åŒæ„ <span class="text-blue-600 underline cursor-pointer" @click="openTerms">æ‹æ‹è³¼å•†å®¶æœƒå“¡æ¢æ¬¾</span></label>
        </div>
        <button @click="register" class="btn-red w-full mt-2 shadow-lg">è¨»å†Š</button>
        <button @click="view='shop'" class="text-xs text-gray-400 mt-6 block mx-auto hover:text-gray-600">å–æ¶ˆ</button>
    </div>

  </div>
  
  <script>
    // é€™è£¡æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Render å¾Œç«¯ç¶²å€ (ä¾‹å¦‚ https://backend.onrender.com/api)
    // æœ¬æ©Ÿæ¸¬è©¦è«‹ç¶­æŒ http://localhost:3000/api
    const API_BASE = 'https://insbuy-project.onrender.com/api'; 
    
    // é€™è£¡æ›¿æ›æˆæ‚¨çš„ Supabase è¨­å®š
    const supabaseUrl = 'https://robgmhyjdfizzxdddqzr.supabase.co';
    const supabaseKey = 'æ‚¨sb_publishable_WlEj-PHW5HuMZ94HXNJYyA_pKYERes4';
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    Vue.createApp({
       data() {
           return {
               view: 'shop', loading: false, submitting: false, isGridView: false, searched: false,
               products: [], cart: [], inquiryResults: [], stats: {daily:0, monthly:0},
               currentShopId: '', inquiryPhone: '', authShopId: '', shopLogo: '', shopName: 'æ‹æ‹è³¼ InsBuy',
               checkoutForm: { name: '', phone: '', address: '', shippingMethodName: '', isFaceToFace: false, meetTime: '', last5: '', note: '' },
               newProduct: { name: '', description: '', images: '', price: '', originalPrice: '', duration: '1', targetAmount: 0, variants: [], shipping: [], bank: {name:'', account:''}, faceToFaceAddress: '', vipConfig: [], questions: [] },
               regForm: { shopName: '', email: '', password: '', company: '', taxId: '', phone: '', agreeTerms: false },
               loginForm: { email: '', password: '', remember: true },
               shopTab: 'active', adminTab: 'active', isEditing: false, editingProductId: null,
               adminLevel: 1, isBanned: false, sheetId: null,
               levelRules: { 1: { maxActive: 1, canEdit: false, canDelete: false, maxDays: 1, imgLimit: 1 } },
               commonBanks: ['ä¸­åœ‹ä¿¡è¨— (822)', 'åœ‹æ³°ä¸–è¯ (013)', 'ç‰å±±éŠ€è¡Œ (808)', 'å°æ–°éŠ€è¡Œ (812)', 'å°åŒ—å¯Œé‚¦ (012)', 'ä¸­è¯éƒµæ”¿ (700)', 'å°ç£éŠ€è¡Œ (004)', 'ç¬¬ä¸€éŠ€è¡Œ (007)', 'è¯å—éŠ€è¡Œ (008)', 'æ°¸è±éŠ€è¡Œ (807)'],
               selectedBank: '', durationSelect: '1',
               adminLoggedIn: false, registrationStatus: 'OPEN',
               orderForm: { variantIdx: -1, qty: 1, answers: {} },
               currentPreviewImage: '',
               showTermsModal: false, termsContent: ''
           }
       },
       computed: {
           isAdminLoggedIn() { return !!this.currentShopId && !!localStorage.getItem('adminCreds'); },
           uniqueBankInfo() { if (this.cart.length === 0) return null; return this.cart[0].bankInfo || {}; },
           filteredProducts() { var self = this; return this.products.filter(function(p) { if (String(p.IsDeleted).toUpperCase() === 'TRUE') { return false; } var isOpen = String(p.Status).toUpperCase() === 'OPEN' && !p.isExpired && p.TotalStock > 0; if (self.shopTab === 'active') { return isOpen; } else { return !isOpen; } }).sort(function(a, b) { if (self.shopTab === 'history') { return new Date(b.EndTime) - new Date(a.EndTime); } return 0; }); },
           adminFilteredProducts() { var self = this; if (!this.products) return []; return this.products.filter(function(p) { var isDel = String(p.IsDeleted).toUpperCase() === 'TRUE'; if (self.adminTab === 'deleted') { return isDel; } var isOpen = String(p.Status).toUpperCase() === 'OPEN' && !p.isExpired && p.TotalStock > 0; if (self.adminTab === 'active') { return !isDel && isOpen; } if (self.adminTab === 'ended') { return !isDel && !isOpen; } return false; }); },
           cartSubTotal() { return this.cart.reduce((s, i) => s + (i.price * i.qty), 0); },
           cartTotalQty() { return this.cart.reduce((s, i) => s + i.qty, 0); },
           currentShippingTotal() { if(this.checkoutForm.isFaceToFace) return 0; var total = 0, method = this.checkoutForm.shippingMethodName; this.cart.forEach(item => { total += this.calculateItemShipping(item, method); }); return total; },
           cartFinalTotal() { return this.cartSubTotal + this.currentShippingTotal; },
           hasFaceToFace() { return this.cart.some(i => i.faceToFaceAddress); },
           faceToFaceAddress() { return this.cart.find(i => i.faceToFaceAddress)?.faceToFaceAddress || ''; },
           currentPrice() { if (this.selectedProduct && this.orderForm.variantIdx >= 0 && this.selectedProduct.variants[this.orderForm.variantIdx]) { return this.selectedProduct.variants[this.orderForm.variantIdx].price; } return this.selectedProduct ? this.selectedProduct.Price : 0; },
           isOutOfStock() { if (!this.selectedProduct) return true; if (this.selectedProduct.variants.length > 0 && this.orderForm.variantIdx >= 0) { return parseInt(this.selectedProduct.variants[this.orderForm.variantIdx].stock) <= 0; } return this.selectedProduct.TotalStock <= 0; },
           currentRules() { return this.levelRules[this.adminLevel] || this.levelRules[1]; },
           checkImageLimit() { var limit = this.currentRules.imgLimit || 3; var currentCount = this.newProduct.images ? this.newProduct.images.split('\\n').length : 0; return currentCount < limit; },
           canDelete() { return this.currentRules.canDelete; },
           canEdit() { return this.currentRules.canEdit; },
           currentActiveCount() { return this.products.filter(p => String(p.Status).toUpperCase() === 'OPEN' && !p.isExpired && String(p.IsDeleted).toUpperCase() !== 'TRUE').length; },
           limitReached() { return this.currentActiveCount >= (this.currentRules.maxActive || 1); },
           availableShippingOptions() { let options = []; if (this.cart.length > 0) { let firstItemRules = this.cart[0].shippingRules || []; firstItemRules.forEach(rule => { let totalFee = 0; this.cart.forEach(cartItem => { totalFee += this.calculateItemShipping(cartItem, rule.name); }); if (rule.name) { options.push({ name: rule.name, totalFee: totalFee, ruleDesc: 'æ¯ ' + rule.limit + ' ä»¶ $' + rule.fee }); } }); } return options; }
       },
       methods: {
           formatNumber(num) { return (num || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); },
           getProgress(item) { if (!item.TargetAmount || item.TargetAmount <= 0) return 0; return Math.floor(((item.CurrentAmount || 0) / item.TargetAmount) * 100); },
           goToOfficialShop() { window.location.href = window.location.origin + window.location.pathname + '?shopId=S001'; },
           
           // API å‘¼å«
           async callApi(endpoint, payload) {
               this.loading = true;
               if(!payload.shopId && this.currentShopId) payload.shopId = this.currentShopId;
               
               if (['getStats', 'inquiry', 'products', 'getTerms', 'getSystemStatus'].includes(endpoint)) {
                   const queryParams = new URLSearchParams(payload).toString();
                   try {
                       const res = await fetch(`${API_BASE}/${endpoint}?${queryParams}`);
                       this.loading = false;
                       return await res.json();
                   } catch(e) {
                       this.loading = false;
                       console.error(e);
                       return {status: 'error', msg: 'Network Error'};
                   }
               }

               try {
                   const res = await fetch(`${API_BASE}/${endpoint}`, {
                       method: 'POST',
                       headers: { 'Content-Type': 'application/json' },
                       body: JSON.stringify(payload)
                   });
                   const json = await res.json();
                   this.loading = false;
                   return json;
               } catch(e) {
                   this.loading = false;
                   alert('é€£ç·šéŒ¯èª¤: ' + e.message);
                   return {status:'error'};
               }
           },

           // åœ–ç‰‡ä¸Šå‚³ (ä½¿ç”¨ supabaseClient)
           async handleFileUpload(ev) {
               var self = this, files = ev.target.files;
               if (!files || files.length === 0) return;
               
               self.submitting = true;
               var uploadPromises = Array.from(files).map(file => {
                   return new Promise(async (resolve) => {
                       const fileName = 'products/' + Date.now() + '_' + file.name;
                       // ã€ä¿®æ­£é»ã€‘æ”¹ç”¨ supabaseClient
                       const { data, error } = await supabaseClient.storage.from('product-images').upload(fileName, file);
                       if (error) { resolve(null); } 
                       else {
                           const { data: { publicUrl } } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
                           resolve(publicUrl);
                       }
                   });
               });

               Promise.all(uploadPromises).then(urls => {
                   var validUrls = urls.filter(u => u !== null);
                   if (validUrls.length > 0) {
                       var newUrls = validUrls.join('\n');
                       self.newProduct.images = self.newProduct.images ? self.newProduct.images + '\n' + newUrls : newUrls;
                   }
                   self.submitting = false;
                   ev.target.value = ''; 
               });
           },

           // Logoä¸Šå‚³ (ä½¿ç”¨ supabaseClient)
           handleLogoUpload(ev) { 
               var self = this, f = ev.target.files[0]; 
               if(!f) return; 
               self.submitting = true;
               const fileName = 'logos/' + Date.now() + '_' + f.name;
               // ã€ä¿®æ­£é»ã€‘æ”¹ç”¨ supabaseClient
               supabaseClient.storage.from('product-images').upload(fileName, f).then(({data, error}) => {
                   if(error) { alert('ä¸Šå‚³å¤±æ•—'); self.submitting=false; return; }
                   const { data: { publicUrl } } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
                   self.shopLogo = publicUrl;
                   self.submitting = false;
               });
           },

           // ç™»å…¥
           adminLogin() { 
               var self=this; 
               self.products = []; 
               self.stats = {daily:0, monthly:0};
               self.submitting = true; 
               this.callApi('login', {email:self.loginForm.email, password:self.loginForm.password}).then(function(d) { 
                   if(d.status==='success') { 
                       const creds = {email: self.loginForm.email, password: self.loginForm.password, shopId: d.shopId};
                       if(self.loginForm.remember) { localStorage.setItem('adminCreds', JSON.stringify(creds)); } 
                       self.authShopId = d.shopId;
                       self.adminLevel = parseInt(d.level) || 1; 
                       self.adminLoggedIn=true; 
                       if(d.shopId === self.currentShopId) {
                           self.view='admin'; 
                           self.fetchProducts(); 
                           self.loadStats(); 
                       } else {
                           window.location.href = window.location.origin + window.location.pathname + '?shopId=' + d.shopId + '&mode=admin&t=' + new Date().getTime();
                       }
                   } else { alert(d.msg); } 
                   self.submitting = false; 
               }); 
           },

           // å–å¾—å•†å“
           fetchProducts() {
               var self = this;
               this.loading = true;
               this.callApi('products', { shopId: this.currentShopId }).then(json => {
                   if(json.status === 'banned') { self.isBanned = true; self.loading = false; return; }
                   if(json.status === 'success') { 
                       self.products = Array.isArray(json.data) ? json.data : [];
                       self.processProducts(self.products);
                       self.shopName = json.shopName || 'æ‹æ‹è³¼ InsBuy'; 
                       self.sheetId = json.sheetId; 
                       self.shopLogo = json.logo || 'https://placehold.co/100?text=Logo'; 
                       if(json.levelRules) { self.levelRules = json.levelRules; } 
                       self.adminLevel = parseInt(json.shopLevel || 1);
                       
                       const urlParams = new URLSearchParams(window.location.search); 
                       const targetPid = urlParams.get('productId');
                       if(targetPid) { const target = self.products.find(p => p.ProductID == targetPid); if(target) self.openProductDetail(target); }
                       
                       self.updateCountdown();
                       setInterval(self.updateCountdown, 60000);
                       
                       if(self.adminLoggedIn) self.loadStats();
                   }
                   self.loading = false;
               });
           },

           // å…¶ä»–æ–¹æ³•
           onDurationChange() { var maxDays = this.currentRules.maxDays || 1; var selectedVal = parseInt(this.durationSelect); if(this.durationSelect === 'custom') { this.newProduct.duration = ''; } else { if (selectedVal > maxDays) { if(confirm('æ‚¨çš„ç­‰ç´šç›®å‰æœ€å¤šåªèƒ½é–‹åœ˜ ' + maxDays + ' å¤©ã€‚\næƒ³è¦é–‹æ›´ä¹…å—ï¼Ÿé»æ“Šç¢ºå®šå‰å¾€å‡ç´šæ–¹æ¡ˆã€‚')) { window.open(window.location.origin + window.location.pathname + '?shopId=S001', '_blank'); } this.durationSelect = '1'; this.newProduct.duration = '1'; } else { this.newProduct.duration = this.durationSelect; } } },
           selectVariant(v, idx) { if(parseInt(v.stock) > 0) { this.orderForm.variantIdx = idx; this.$forceUpdate(); } },
           selectShippingMethod(opt) { if(opt.name === 'é¢äº¤') { this.checkoutForm.shippingMethodName = 'é¢äº¤'; this.checkoutForm.isFaceToFace = true; } else { this.checkoutForm.shippingMethodName = opt.name; this.checkoutForm.isFaceToFace = false; } },
           handleNav(target) { this.view = target; window.scrollTo(0,0); },
           goToRegister() { this.regForm = { shopName: '', email: '', password: '', company: '', taxId: '', phone: '', agreeTerms: false }; this.view = 'register'; window.scrollTo(0,0); },
           goToAdmin() {
               const storedCreds = localStorage.getItem('adminCreds');
               if (storedCreds) {
                   let creds = {};
                   try { creds = JSON.parse(storedCreds); } catch(e){}
                   if (creds.email && creds.shopId) {
                       if(creds.shopId === this.currentShopId) { this.view = 'admin'; this.adminLoggedIn = true; this.authShopId = creds.shopId; this.loadStats(); } 
                       else { window.location.href = window.location.origin + window.location.pathname + '?shopId=' + creds.shopId + '&mode=admin'; }
                   } else { this.view = 'admin-login'; }
               } else { this.view = 'admin-login'; }
               window.scrollTo(0,0);
           },
           checkUpgrade(featureName) { if(confirm(featureName + ' éœ€è¦æ›´é«˜æ¬Šé™ï¼Œè«‹å‡ç´šæ–¹æ¡ˆã€‚æ˜¯å¦å‰å¾€æŸ¥çœ‹ï¼Ÿ')) { window.open(window.location.origin + window.location.pathname + '?shopId=S001', '_blank'); } },
           clickTitle() { this.goToOfficialShop(); },
           copyShopLink() { const url = window.location.origin + window.location.pathname + '?shopId=' + this.currentShopId; this.copyText(url); },
           copyProductLink(item) { const url = window.location.origin + window.location.pathname + '?shopId=' + this.currentShopId + '&productId=' + item.ProductID; this.copyText(url); alert('å•†å“é€£çµå·²è¤‡è£½'); },
           openSheet() { alert('ç¾åœ¨æ”¹ç”¨ Supabaseï¼Œæ‰€æœ‰æ•¸æ“šéƒ½åœ¨é›²ç«¯å¾Œå°ã€‚'); },
           showToast(msg) { var t = document.getElementById("toast"); t.innerText = msg; t.classList.remove("hidden"); setTimeout(function() { t.classList.add("hidden"); }, 1500); },
           copyText(text) { navigator.clipboard.writeText(text).then(() => { var t = document.getElementById("toast"); t.classList.remove("hidden"); setTimeout(() => { t.classList.add("hidden"); }, 1500); }); },
           addQuestion() { this.newProduct.questions.push({ title: '', required: false }); },
           increaseQty() { var max = 999; if(this.selectedProduct.variants.length > 0 && this.orderForm.variantIdx >= 0) { max = parseInt(this.selectedProduct.variants[this.orderForm.variantIdx].stock); } else { max = this.selectedProduct.TotalStock; } if(this.orderForm.qty < max) { this.orderForm.qty++; } },
           decreaseQty() { if(this.orderForm.qty > 1) { this.orderForm.qty--; } },
           validateQty() { let max = 999; if(this.selectedProduct.variants.length > 0 && this.orderForm.variantIdx >= 0) { max = parseInt(this.selectedProduct.variants[this.orderForm.variantIdx].stock); } else { max = this.selectedProduct.TotalStock; } if(this.orderForm.qty < 1) this.orderForm.qty = 1; if(this.orderForm.qty > max) this.orderForm.qty = max; },
           addToCart(jump) {
                if(this.isOutOfStock) { return; }
                if(this.selectedProduct.variants.length > 0 && this.orderForm.variantIdx < 0) { alert('è«‹é¸æ“‡è¦æ ¼'); return; }
                var questions = this.selectedProduct.Questions || [];
                var vName = '', price = this.selectedProduct.Price, image = this.selectedProduct.imagesList[0] || '';
                if(this.orderForm.variantIdx >= 0) { var v = this.selectedProduct.variants[this.orderForm.variantIdx]; vName = v.name; price = v.price; }
                this.cart.push({ 
                    productId: this.selectedProduct.ProductID, 
                    productName: this.selectedProduct.ProductName, 
                    variantName: vName, 
                    price: price, 
                    qty: this.orderForm.qty, 
                    image: image, 
                    shippingRules: this.selectedProduct.shippingRules, 
                    bankInfo: this.selectedProduct.bankInfo, 
                    faceToFaceAddress: this.selectedProduct.faceToFaceAddress,
                    questions: questions,
                    answers: {} 
                });
                if (jump) { this.view = 'cart'; window.scrollTo(0,0); } else { this.showToast('å·²åŠ å…¥è³¼ç‰©è»Š'); }
           },
           removeFromCart(idx) { this.cart.splice(idx, 1); },
           calculateItemShipping(item, methodName) { if (!item.shippingRules) { return 0; } var rule = item.shippingRules.find(function(r) { return r.name === methodName; }); if (!rule) { return 0; } var limit = parseInt(rule.limit) || 1; var fee = parseInt(rule.fee) || 0; return Math.ceil(item.qty / limit) * fee; },
           submitOrder() {
                var self = this, f = self.checkoutForm;
                if(!f.name || !f.phone) { alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }
                if(!f.isFaceToFace && !f.address) { alert('è«‹å¡«å¯«åœ°å€'); return; }
                if(!f.shippingMethodName) { alert('è«‹é¸æ“‡é‹é€æ–¹å¼'); return; }
                if(f.isFaceToFace && !f.meetTime) { alert('è«‹é¸æ“‡é¢äº¤æ™‚é–“'); return; }
                for (let i = 0; i < self.cart.length; i++) {
                    let item = self.cart[i];
                    if (item.questions && item.questions.length > 0) {
                        for (let q of item.questions) {
                            if (q.required && (!item.answers[q.title] || item.answers[q.title].trim() === '')) {
                                alert('è«‹å¡«å¯«å•†å“ [' + item.productName + '] çš„å¿…å¡«æ¬„ä½ï¼š' + q.title);
                                return;
                            }
                        }
                    }
                }
                if(!confirm('å·²ç¢ºèªç‚ºå®‰å…¨åœ˜è³¼ä¸¦éè©é¨™ï¼Œæˆ‘é¡˜æ„ç‚ºè³¼è²·è² è²¬')) return;
                self.submitting = true; 
                var itemsPayload = self.cart.map(function(item) {
                    var itemShipFee = f.isFaceToFace ? 0 : self.calculateItemShipping(item, f.shippingMethodName);
                    return { productId: item.productId, productName: item.productName, variantName: item.variantName, price: item.price, qty: item.qty, shippingFee: itemShipFee, total: (item.price * item.qty) + itemShipFee, answers: item.answers };
                });
                var payload = { shopId: self.currentShopId, cart: itemsPayload, customer: { name: f.name, phone: f.phone, address: f.address, shipping: f.isFaceToFace ? 'é¢äº¤' : f.shippingMethodName, last5: f.last5, note: f.note, meetTime: f.meetTime } };
                self.callApi('submitOrder', payload).then(function(d) {
                    self.submitting = false; 
                    if(d.status==='success') { alert('è¨‚å–®å»ºç«‹æˆåŠŸï¼ç·¨è™Ÿ: ' + d.orderId); self.cart = []; self.checkoutForm = { name: '', phone: '', address: '', shippingMethodName: '', isFaceToFace: false, meetTime: '', last5: '', note: '' }; self.view = 'shop'; self.fetchProducts(); window.scrollTo(0,0); } 
                    else if(d.errors) { alert('ä¸‹å–®å¤±æ•—ï¼š\n' + d.errors.join('\n')); }
                    else { alert(d.msg); }
                });
           },
           handleEditClick(item) { if(!this.canEdit) { return this.checkUpgrade('ç·¨è¼¯åœ˜è³¼'); } this.editProduct(item); },
           handleDeleteClick(pid) { if(!this.canDelete) { return this.checkUpgrade('åˆªé™¤åœ˜è³¼'); } this.deleteProduct(pid); },
           saveProduct() {
                 var self = this; self.submitting = true; 
                 if(self.newProduct.bank && self.newProduct.bank.account) { localStorage.setItem('savedBank', JSON.stringify(self.newProduct.bank)); }
                 var payload = Object.assign({ productId: self.isEditing ? self.editingProductId : null }, self.newProduct);
                 payload.shopId = self.currentShopId;
                 self.callApi('createProduct', payload).then(function(data) {
                     if(data.status==='success') { alert(data.msg); self.fetchProducts(); self.isEditing=false; self.resetForm(); } else { alert(data.msg); }
                     self.submitting = false;
                 });
           },
           removeImage(index) {
               var imgs = this.newProduct.images.split('\n');
               imgs.splice(index, 1);
               this.newProduct.images = imgs.join('\n');
           },
           toggleRegistration() { var self = this; var newStatus = (self.registrationStatus === 'OPEN') ? 'CLOSED' : 'OPEN'; self.submitting = true; self.callApi('toggleRegistration', {shopId: self.currentShopId, status: newStatus}).then(function(d) { if(d.status === 'success') { self.registrationStatus = newStatus; } else { alert(d.msg); } self.submitting = false; }); },
           getSystemStatus() { var self = this; this.callApi('getSystemStatus', {}).then(d=>{ if(d.status==='success') self.registrationStatus = d.registration; }); },
           register() { 
               var self=this; 
               if(!self.regForm.shopName || !self.regForm.password || !self.regForm.phone) { return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š (å«é›»è©±)'); } 
               if(!self.regForm.agreeTerms) { return alert('è«‹å…ˆé–±è®€ä¸¦åŒæ„å•†å®¶æœƒå“¡æ¢æ¬¾'); }
               self.submitting = true; 
               this.callApi('register', self.regForm).then(function(d) { if(d.status==='success') { localStorage.setItem('adminCreds', JSON.stringify({email: self.regForm.email, password: self.regForm.password})); self.currentShopId = d.shopId; self.adminLevel = 1; self.adminLoggedIn=true; self.view = 'admin'; self.fetchProducts(); } else { alert(d.msg); } self.submitting = false; }); 
           },
           resetPassword() { var self=this; if(!self.loginForm.email) return alert('è«‹è¼¸å…¥ Email'); self.submitting = true; this.callApi('resetPassword', {email:self.loginForm.email}).then(function(d) { alert(d.msg); self.submitting = false; if(d.status==='success') self.view='admin-login'; }); },
           logout() { localStorage.removeItem('adminCreds'); this.currentShopId = ''; this.adminLoggedIn=false; this.view = 'admin-login'; },
           resetForm() { var savedBank = localStorage.getItem('savedBank'); var b = savedBank ? JSON.parse(savedBank) : {name:'', account:''}; this.selectedBank = b.name || ''; this.durationSelect = '1'; this.newProduct = { name: '', description: '', images: '', duration: '1', targetAmount: 0, price: '', originalPrice: '', shipping: [], bank: b, variants: [{name:'', price:'', stock:''}], faceToFaceAddress: '', vipConfig: [], questions: [] }; },
           onBankChange() { if(this.selectedBank && this.selectedBank !== 'Other') { this.newProduct.bank.name = this.selectedBank; } else { this.newProduct.bank.name = ''; } },
           addShippingRule(type) { if(type === 'å…¶ä»–') { this.newProduct.shipping.push({name: '', fee: '', limit: ''}); } else if (type === 'é¢äº¤') { if(!this.newProduct.shipping.some(s=>s.name==='é¢äº¤')) { this.newProduct.shipping.push({name: 'é¢äº¤', fee: 0, limit: 1}); } } else { var fee = ''; if(type === 'å®…é…') fee = ''; this.newProduct.shipping.push({name: type, fee: fee, limit: ''}); } },
           addVariant() { if (this.adminLevel == 1 && this.newProduct.variants.length >= 1) { return this.checkUpgrade('æ–°å¢æ›´å¤šè¦æ ¼'); } this.newProduct.variants.push({name:'', price:'', stock:'', isVip: false}); },
           handleLoginClick() { this.goToAdmin(); },
           updateShopSettings() { var self = this; self.submitting = true; self.callApi('updateShopInfo', {shopId: self.currentShopId, shopName: self.shopName, shopLogo: self.shopLogo}).then(function(d) { alert(d.msg); self.submitting = false; }); },
           
           updateCountdown() {
                var now = new Date();
                this.products.forEach(function(p) {
                    if(p.EndTime) {
                        var diff = new Date(p.EndTime) - now;
                        if(diff > 0) {
                            var d = Math.floor(diff / (1000*60*60*24));
                            var h = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
                            var m = Math.floor((diff % (1000*60*60)) / (1000*60));
                            p.remainingStr = d + "å¤©" + h + "æ™‚" + m + "åˆ†";
                        } else { p.remainingStr = ""; p.isExpired = true; }
                    }
                });
           },
           openTerms() { this.showTermsModal = true; if (!this.termsContent) { this.fetchTerms(); } },
           fetchTerms() { var self = this; this.callApi('getTerms', {}).then(d => { if (d.status === 'success') { self.termsContent = d.terms; } else { self.termsContent = 'ç„¡æ³•è®€å–æ¢æ¬¾'; } }); },
           checkOrders() { if(!this.inquiryPhone) return alert('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼'); this.submitting = true; this.inquiryResults = []; this.callApi('inquiry', {phone: this.inquiryPhone, shopId: this.currentShopId}).then(res => { this.inquiryResults = res.orders || []; this.searched = true; this.submitting = false; }); },
           loadStats() { this.callApi('getStats', {shopId: this.currentShopId}).then(res => this.stats = res); },
           processProducts(data) {
                if(!Array.isArray(data)) { this.products = []; return; }
                this.products = data.map(function(p) {
                    var imgs = (p.Images && typeof p.Images === 'string') ? p.Images.split(/\r?\n/) : [];
                    try { p.isExpired = new Date(p.EndTime) < new Date(); } catch(e){ p.isExpired = false; }
                    var per = 0; if(p.TargetAmount>0) { per = Math.floor((p.CurrentAmount/p.TargetAmount)*100); }
                    p.imagesList = imgs; p.progressPercent = per; 
                    try { p.shippingRules = JSON.parse(p.ShippingMethod || '[]'); } catch(e){ p.shippingRules = []; }
                    try { p.bankInfo = JSON.parse(p.BankInfo || '{}'); } catch(e){ p.bankInfo = {}; }
                    if (Array.isArray(p.Variants)) { p.variants = p.Variants; } else if (typeof p.Variants === 'string' && p.Variants.trim() !== '') { try { p.variants = JSON.parse(p.Variants); } catch(e) { p.variants = []; } } else { p.variants = []; }
                    if(p.variants.length > 0) { p.TotalStock = p.variants.reduce((sum, v) => { let s = parseInt(v.stock); return sum + (isNaN(s) ? 0 : s); }, 0); } else { p.TotalStock = parseInt(p.TotalStock) || 0; }
                    p.shippingFee = p.shippingRules.length>0 ? p.shippingRules[0].fee : 0; p.remainingTime = ''; p.faceToFaceAddress = p.FaceToFaceAddress || '';
                    return p;
                });
           },
           editProduct(item) { this.isEditing = true; this.editingProductId = item.ProductID; this.newProduct = { name: item.ProductName, description: item.Description, images: item.imagesList.join('\n'), duration: '1', targetAmount: item.TargetAmount, price: item.Price, originalPrice: item.OriginalPrice, shipping: JSON.parse(JSON.stringify(item.shippingRules)), bank: JSON.parse(JSON.stringify(item.bankInfo)), variants: JSON.parse(JSON.stringify(item.variants)), faceToFaceAddress: item.faceToFaceAddress, questions: JSON.parse(JSON.stringify(item.Questions || [])) }; if(this.commonBanks.includes(item.bankInfo.name)) { this.selectedBank = item.bankInfo.name; } else if (item.bankInfo.name) { this.selectedBank = 'Other'; } document.getElementById('adminForm').scrollIntoView({behavior: 'smooth'}); },
           openProductDetail(item) { 
               this.selectedProduct = item; 
               this.currentPreviewImage = item.imagesList[0] || ''; 
               this.orderForm = { variantIdx: (item.variants && item.variants.length > 0) ? -1 : -2, qty: 1, answers: {} }; 
               this.view = 'product'; 
               window.scrollTo(0,0); 
           }
       },
       mounted() {
           var path = window.location.pathname; 
           const urlParams = new URLSearchParams(window.location.search);
           if (!urlParams.has('shopId')) { window.location.href = window.location.origin + window.location.pathname + '?shopId=S001'; return; }
           this.currentShopId = urlParams.get('shopId');
           if(this.currentShopId === 'S001') this.getSystemStatus();

           const creds = localStorage.getItem('adminCreds'); 
           if (creds && urlParams.get('mode') === 'admin') {
               try {
                   const c = JSON.parse(creds);
                   if(c.email && c.shopId === this.currentShopId) {
                       this.adminLoggedIn = true;
                       this.authShopId = c.shopId;
                       this.view = 'admin'; 
                       this.loadStats();
                   }
               } catch(e) {}
           } else if (creds) {
               try {
                   const c = JSON.parse(creds);
                   if(c.email) {
                       this.adminLoggedIn = true;
                       this.authShopId = c.shopId;
                   }
               } catch(e) {}
           }
           this.fetchProducts();
       }
    }).mount('#app');
  </script>
</body>
</html>