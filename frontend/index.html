<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>æ‹æ‹è³¼ InsBuy</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* æ ¸å¿ƒæ¨£å¼ */
    [v-cloak] { display: none; }
    body { background-color: #F3F4F6; font-family: 'Noto Sans TC', sans-serif; padding-bottom: 90px; }
    
    /* ä¸»é¡Œè‰²é…ç½® (æ¹–æ°´ç¶  + æ´»åŠ›æ©˜) */
    :root { --teal-main: #14b8a6; --orange-accent: #f97316; }
    .bg-teal-main { background-color: var(--teal-main); }
    .text-teal-main { color: var(--teal-main); }
    .bg-orange-accent { background-color: var(--orange-accent); }
    .text-orange-accent { color: var(--orange-accent); }

    /* UI å…ƒä»¶å„ªåŒ– */
    .input-field { @apply w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-teal-500 transition; }
    .btn-action { @apply w-full py-3 rounded-lg font-bold text-white shadow-md transition active:scale-95 text-center block; }
    .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    
    /* åº•éƒ¨å°èˆªåˆ— */
    .bottom-nav-item { @apply flex flex-col items-center justify-center text-gray-400 text-[10px] space-y-1 cursor-pointer transition; }
    .bottom-nav-item.active { @apply text-teal-600 font-bold; }
    .bottom-nav-item i { font-size: 20px; margin-bottom: 2px; }

    /* å¾Œå° Grid Menu */
    .grid-menu-item { @apply flex flex-col items-center justify-center bg-white p-4 rounded-2xl shadow-sm border border-gray-100 active:bg-gray-50 cursor-pointer transition hover:shadow-md; }
    .grid-menu-icon { @apply text-3xl mb-2 text-teal-500; }
    
    /* å•†å“è©³æƒ…é è¡¨æ ¼ */
    .spec-table td { @apply p-3 border-b border-gray-100 text-sm; }
    .spec-table tr:last-child td { border-bottom: none; }
    .spec-label { @apply font-bold text-gray-500 w-24; }
    
    /* Loading å‹•ç•« */
    .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid var(--teal-main); width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative bg-gray-50 flex flex-col shadow-2xl">
    
    <div v-if="loading" class="fixed inset-0 bg-white/90 z-[999] flex items-center justify-center flex-col backdrop-blur-sm">
        <div class="loader mb-2" style="width: 40px; height: 40px;"></div>
        <div class="text-sm font-bold text-gray-600">è™•ç†ä¸­...</div>
    </div>

    <div v-if="view.includes('admin')" class="bg-teal-main pt-12 pb-16 px-6 text-white relative rounded-b-[30px] shadow-lg mb-6">
        <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-full bg-white p-1 shadow-inner">
                <img :src="shopLogo || 'https://placehold.co/100?text=Logo'" class="w-full h-full rounded-full object-cover">
            </div>
            <div>
                <h2 class="text-xl font-bold tracking-wide">{{ shopName }}</h2>
                <div class="text-xs opacity-80 mt-1 bg-black/10 px-2 py-0.5 rounded-full inline-block">çµ±ç·¨ï¼š{{ currentShopId }}</div>
            </div>
            <button @click="logout" class="ml-auto border border-white/40 px-4 py-1.5 rounded-full text-xs hover:bg-white/20 transition">ç™»å‡º</button>
        </div>
        <div class="mt-6 flex justify-between items-end px-2">
            <div>
                <div class="text-sm opacity-80">æœ¬æœˆæ¥­ç¸¾é”æˆ</div>
                <div class="text-3xl font-black tracking-tighter">85<span class="text-base font-normal">%</span></div>
            </div>
            <div class="text-right">
                <div class="text-xs opacity-60">ä»Šæ—¥è¨ªå®¢</div>
                <div class="font-bold text-lg">1,208</div>
            </div>
        </div>
    </div>

    <div v-else class="bg-white sticky top-0 z-50 shadow-sm border-b border-gray-100">
        <div class="bg-gray-900 text-white text-[10px] py-1.5 px-3 flex justify-between items-center">
             <div v-if="user" class="flex items-center gap-2">
                 <img :src="user.user_metadata.avatar_url" class="w-4 h-4 rounded-full border border-white">
                 <span class="font-bold">Hi, {{ user.user_metadata.full_name }}</span>
             </div>
             <div v-else class="text-gray-400">è¨ªå®¢æ¨¡å¼ (è«‹ç™»å…¥ä»¥ç®¡ç†è¨‚å–®)</div>
             
             <button v-if="!user" @click="loginLine" class="bg-[#06C755] hover:bg-[#05b34c] text-white px-2 py-0.5 rounded flex items-center font-bold transition">
                 <i class="fa-brands fa-line mr-1"></i>LINE ç™»å…¥
             </button>
        </div>
        <div class="flex items-center justify-between p-3 bg-white/95 backdrop-blur">
            <h1 class="font-black text-lg text-gray-800 flex items-center gap-2" @click="view='shop'">
                <img v-if="shopLogo" :src="shopLogo" class="w-6 h-6 rounded-md object-cover">
                {{ shopName }}
            </h1>
            <div class="flex gap-1">
                <button @click="view='shop'" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-magnifying-glass"></i></button>
                <button @click="view='cart'" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600 relative">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span v-if="cart.length>0" class="absolute top-0 right-0 bg-red-500 text-white text-[9px] w-3.5 h-3.5 rounded-full flex items-center justify-center font-bold">{{cart.length}}</span>
                </button>
            </div>
        </div>
    </div>

    <div v-if="view === 'admin-home'" class="px-4 -mt-10 relative z-10 grid grid-cols-2 gap-3 pb-24">
        <div @click="view='admin-orders'" class="grid-menu-item">
            <i class="fa-solid fa-file-invoice-dollar grid-menu-icon"></i>
            <span class="font-bold text-gray-700 text-sm">è¨‚å–®ç®¡ç†</span>
            <span class="text-[10px] text-gray-400 mt-1">å¾…å‡ºè²¨ {{ stats.pendingShip || 0 }} ç­†</span>
        </div>
        <div @click="view='admin-coupons'" class="grid-menu-item">
            <i class="fa-solid fa-ticket grid-menu-icon text-orange-500"></i>
            <span class="font-bold text-gray-700 text-sm">å„ªæƒ åˆ¸è¨­å®š</span>
            <span class="text-[10px] text-gray-400 mt-1">é€²è¡Œä¸­ 2 æª”</span>
        </div>
        <div @click="view='admin-products'" class="grid-menu-item">
            <i class="fa-solid fa-box-open grid-menu-icon text-blue-500"></i>
            <span class="font-bold text-gray-700 text-sm">å•†å“ä¸Šæ¶</span>
        </div>
        <div @click="alert('åŠŸèƒ½é–‹ç™¼ä¸­')" class="grid-menu-item">
            <i class="fa-solid fa-chart-pie grid-menu-icon text-purple-500"></i>
            <span class="font-bold text-gray-700 text-sm">æ•¸æ“šåˆ†æ</span>
        </div>
        <div @click="copyShopLink" class="grid-menu-item col-span-2 flex-row gap-3 bg-gray-800 border-gray-800">
            <i class="fa-solid fa-share-nodes text-white text-xl mb-0"></i>
            <span class="font-bold text-white">è¤‡è£½è³£å ´é€£çµåˆ†äº«</span>
        </div>
    </div>

    <div v-if="view === 'admin-orders'" class="p-4 space-y-4 pb-24">
        <div class="flex items-center mb-2">
            <button @click="view='admin-home'" class="text-gray-400 mr-2 hover:text-gray-600"><i class="fa-solid fa-chevron-left"></i></button>
            <h2 class="font-bold text-lg">è¨‚å–®ç®¡ç†</h2>
        </div>
        
        <div class="rounded-xl overflow-hidden card-shadow bg-white border border-gray-100">
            <div class="bg-orange-accent text-white py-2 px-4 font-bold text-sm flex justify-between items-center">
                <span>è¨‚å–®æ¦‚æ³</span>
                <i class="fa-solid fa-circle-info opacity-50"></i>
            </div>
            <div class="grid grid-cols-3 divide-x divide-gray-100 py-4">
                <div class="text-center px-2">
                    <div class="text-2xl font-black text-orange-500">{{ stats.newOrders || 0 }}</div>
                    <div class="text-xs text-gray-500 font-bold mt-1">æ–°è¨‚å–®</div>
                </div>
                <div class="text-center px-2">
                    <div class="text-2xl font-black text-orange-500">{{ stats.pendingShip || 0 }}</div>
                    <div class="text-xs text-gray-500 font-bold mt-1">å¾…å‡ºè²¨</div>
                </div>
                <div class="text-center px-2">
                    <div class="text-2xl font-black text-gray-800">{{ stats.shipped || 0 }}</div>
                    <div class="text-xs text-gray-500 font-bold mt-1">å·²å‡ºè²¨</div>
                </div>
            </div>
        </div>

        <div v-if="adminOrderList.length > 0" class="space-y-3">
            <div v-for="order in adminOrderList" :key="order.order_id" class="bg-white p-4 rounded-xl card-shadow border border-gray-50">
                <div class="flex justify-between border-b border-gray-100 pb-2 mb-2">
                    <span class="font-bold text-gray-800">{{ order.customer_name }}</span>
                    <select v-model="order.status_detail" @change="updateOrderStatus(order)" 
                            class="text-xs border rounded px-2 py-1 bg-gray-50 font-bold"
                            :class="{'text-green-600': order.status_detail==='completed', 'text-red-500': order.status_detail==='cancelled'}">
                        <option value="pending_payment">å¾…ä»˜æ¬¾</option>
                        <option value="paid">å·²ä»˜æ¬¾</option>
                        <option value="shipped">å·²å‡ºè²¨</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div class="flex justify-between items-end">
                    <div class="text-xs text-gray-400">
                        <div>å–®è™Ÿï¼š{{ order.order_id }}</div>
                        <div>æ—¥æœŸï¼š{{ new Date(order.created_at).toLocaleDateString() }}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-black text-red-500 text-lg">${{ order.total_amount }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div v-else class="text-center text-gray-400 py-10">å°šç„¡è¨‚å–®è³‡æ–™</div>
    </div>

    <div v-if="view === 'admin-coupons'" class="p-4 pb-24">
        <div class="flex items-center mb-4">
            <button @click="view='admin-home'" class="text-gray-400 mr-2"><i class="fa-solid fa-chevron-left"></i></button>
            <h2 class="font-bold text-lg">å„ªæƒ åˆ¸è¨­å®š</h2>
        </div>
        <div class="bg-white p-5 rounded-xl card-shadow mb-4">
            <h3 class="font-bold mb-3 text-gray-700">å»ºç«‹æ–°å„ªæƒ åˆ¸</h3>
            <input v-model="newCoupon.code" placeholder="å„ªæƒ ç¢¼ (ä¾‹å¦‚: VIP888)" class="input-field mb-3 uppercase">
            <input v-model="newCoupon.discount" type="number" placeholder="æŠ˜æ‰£é‡‘é¡ ($)" class="input-field mb-4">
            <button @click="createCoupon" class="btn-action bg-teal-main">å»ºç«‹å„ªæƒ åˆ¸</button>
        </div>
    </div>

    <div v-if="view === 'shop'" class="p-4 pb-24">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 p-4 rounded-xl mb-6 shadow-sm">
            <div class="text-xs font-bold text-blue-600 mb-2 flex items-center">
                <i class="fa-solid fa-robot mr-2 text-lg"></i> 
                <span>æ‡¶äººä¸‹å–® (è²¼ä¸Šå¦‚ï¼šç´…è‰²+1 è—è‰²+2)</span>
            </div>
            <div class="flex gap-2">
                <input v-model="aiInput" class="flex-1 text-sm border-0 shadow-inner bg-white rounded-lg px-3" placeholder="è²¼ä¸Šæ–‡å­—...">
                <button @click="parseAiOrder" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow">è§£æ</button>
            </div>
        </div>

        <div v-if="products.length > 0" class="grid grid-cols-2 gap-4">
            <div v-for="p in products" :key="p.product_id" @click="openProduct(p)" class="bg-white rounded-xl card-shadow overflow-hidden relative group cursor-pointer">
                <div class="aspect-square bg-gray-100 overflow-hidden">
                    <img :src="p.images?.split('\n')[0] || 'https://placehold.co/300'" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                </div>
                <div v-if="p.total_stock < 10" class="absolute top-2 left-2 bg-red-600 text-white text-[10px] px-2 py-1 rounded-full font-bold shadow-md animate-pulse">
                    ğŸ”¥ å‰© {{ p.total_stock }} çµ„
                </div>
                <div class="p-3">
                    <div class="font-bold text-gray-800 truncate mb-1">{{ p.name }}</div>
                    <div class="flex justify-between items-end">
                        <div>
                            <span class="text-xs text-gray-400 line-through mr-1">${{ p.original_price }}</span>
                            <span class="text-red-600 font-black text-lg">${{ p.price }}</span>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-teal-600 group-hover:bg-teal-50 transition">
                            <i class="fa-solid fa-cart-plus"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div v-else class="text-center text-gray-400 py-20">
            <i class="fa-solid fa-box-open text-4xl mb-2 opacity-30"></i>
            <p>ç›®å‰æ²’æœ‰å•†å“ä¸Šæ¶</p>
        </div>
    </div>

    <div v-if="view === 'product' && selectedProduct" class="bg-white min-h-screen pb-24">
        <div class="relative">
            <img :src="selectedProduct.images?.split('\n')[0]" class="w-full h-96 object-cover">
            <button @click="view='shop'" class="absolute top-4 left-4 bg-black/40 backdrop-blur text-white w-10 h-10 rounded-full flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></button>
        </div>
        
        <div class="p-5">
            <h1 class="text-2xl font-black text-gray-800 mb-2">{{ selectedProduct.name }}</h1>
            <div class="flex items-baseline gap-2 mb-6 border-b border-gray-100 pb-4">
                <span class="text-3xl font-black text-red-600">${{ selectedProduct.price }}</span>
                <span class="text-gray-400 line-through">åŸåƒ¹ ${{ selectedProduct.original_price }}</span>
            </div>

            <table class="w-full spec-table mb-6">
                <tr>
                    <td class="spec-label">è¦æ ¼é¸æ“‡</td>
                    <td>
                        <select v-model="orderForm.variant" class="w-full border border-gray-300 p-2 rounded-lg bg-white">
                            <option value="" disabled>è«‹é¸æ“‡è¦æ ¼</option>
                            <option v-for="v in selectedProduct.variants" :value="v.name" :disabled="parseInt(v.stock)<=0">
                                {{ v.name }} (å‰©{{v.stock}})
                            </option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="spec-label">è³¼è²·æ•¸é‡</td>
                    <td>
                        <div class="flex items-center border border-gray-300 rounded-lg w-32 overflow-hidden">
                            <button @click="orderForm.qty > 1 ? orderForm.qty-- : null" class="w-10 h-10 bg-gray-50 hover:bg-gray-100 border-r">-</button>
                            <input v-model.number="orderForm.qty" class="w-full text-center outline-none h-10 font-bold bg-white" readonly>
                            <button @click="orderForm.qty++" class="w-10 h-10 bg-gray-50 hover:bg-gray-100 border-l">+</button>
                        </div>
                    </td>
                </tr>
            </table>

            <div class="bg-gray-50 p-4 rounded-xl mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-700 text-sm">è³£å®¶è³‡è¨Š</h3>
                    <button class="text-xs text-gray-400 hover:text-red-500 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-1"></i>æª¢èˆ‰</button>
                </div>
                <div class="flex gap-2">
                    <button @click="contactLine" class="flex-1 bg-[#06C755] text-white py-2.5 rounded-lg font-bold text-sm shadow-sm hover:opacity-90">
                        <i class="fa-brands fa-line mr-1 text-lg align-middle"></i> è¯çµ¡è³£å®¶
                    </button>
                    <button @click="shareProduct" class="flex-1 bg-white border border-teal-500 text-teal-600 py-2.5 rounded-lg font-bold text-sm shadow-sm">
                        <i class="fa-solid fa-share-nodes mr-1"></i> åˆ†äº«é€£çµ
                    </button>
                </div>
            </div>
            
            <div class="text-xs text-gray-400 text-center mt-4">
                æ­¤å¹³å°å·²å•Ÿç”¨ SSL å®‰å…¨åŠ å¯†ï¼Œè«‹å®‰å¿ƒè³¼è²·
            </div>
        </div>

        <div class="fixed bottom-0 w-full p-4 bg-white border-t border-gray-200 safe-pb z-40 max-w-md mx-auto shadow-[0_-4px_15px_rgba(0,0,0,0.05)]">
            <div class="flex gap-3">
                <div class="flex-1 flex flex-col justify-center">
                    <span class="text-xs text-gray-500">ç¸½è¨ˆé‡‘é¡</span>
                    <span class="font-black text-xl text-red-600">${{ selectedProduct.price * orderForm.qty }}</span>
                </div>
                <button @click="addToCart" class="flex-[2] btn-action bg-orange-accent text-lg">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>
    </div>

    <div v-if="view === 'cart'" class="p-4 pb-24 bg-gray-50 min-h-screen">
        <h2 class="font-black text-xl mb-4 text-gray-800">æˆ‘çš„è³¼ç‰©è»Š</h2>
        
        <div v-if="cart.length > 0" class="space-y-4">
            <div v-for="(item, idx) in cart" :key="idx" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-4 relative">
                <div class="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                    <img :src="item.images?.split('\n')[0]" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 pr-6">
                    <div class="font-bold text-gray-800 mb-1 line-clamp-1">{{ item.name }}</div>
                    <div class="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-1 rounded mb-2">è¦æ ¼: {{ item.variant }}</div>
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-500">x {{ item.qty }}</div>
                        <div class="text-red-600 font-black text-lg">${{ item.price * item.qty }}</div>
                    </div>
                </div>
                <button @click="cart.splice(idx,1)" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm mt-4">
                <label class="block text-sm font-bold mb-2 text-gray-700"><i class="fa-solid fa-ticket mr-1 text-orange-500"></i>å„ªæƒ åˆ¸ / æŠ˜æ‰£ç¢¼</label>
                <div class="flex gap-2">
                    <input v-model="couponCode" placeholder="è¼¸å…¥ä»£ç¢¼" class="input-field bg-gray-50">
                    <button @click="applyCoupon" class="bg-gray-800 text-white px-4 rounded-lg text-sm font-bold whitespace-nowrap">å¥—ç”¨</button>
                </div>
                <div v-if="discount > 0" class="text-green-600 text-sm mt-2 font-bold flex items-center">
                    <i class="fa-solid fa-check-circle mr-1"></i> å·²æŠ˜æŠµ ${{ discount }}
                </div>
            </div>

            <div class="mt-6 bg-white p-5 rounded-xl shadow-lg border border-gray-100">
                <div class="flex justify-between mb-2 text-sm text-gray-500"><span>å•†å“å°è¨ˆ</span><span>${{ cartTotal }}</span></div>
                <div class="flex justify-between mb-2 text-sm text-green-600" v-if="discount > 0"><span>æŠ˜æ‰£å„ªæƒ </span><span>-${{ discount }}</span></div>
                <div class="border-t border-gray-100 my-3"></div>
                <div class="flex justify-between items-end mb-4">
                    <span class="font-bold text-gray-800">çµå¸³ç¸½é‡‘é¡</span>
                    <span class="text-2xl font-black text-red-600">${{ Math.max(0, cartTotal - discount) }}</span>
                </div>
                <button @click="checkout" class="btn-action bg-red-600 text-lg shadow-red-200">å»è²·å–®</button>
            </div>
        </div>
        
        <div v-else class="text-center py-32 text-gray-400">
            <i class="fa-solid fa-cart-arrow-down text-6xl mb-4 opacity-20"></i>
            <p class="font-bold">è³¼ç‰©è»Šç©ºç©ºçš„</p>
            <button @click="view='shop'" class="mt-6 text-teal-600 font-bold underline">è¶•å¿«å»é€›é€›</button>
        </div>
    </div>

    <div v-if="view === 'orders'" class="p-4 pb-24 bg-gray-50 min-h-screen">
        <h2 class="font-black text-xl mb-4 text-gray-800">æˆ‘çš„è¨‚å–®</h2>
        <div v-if="!user" class="text-center py-10">
            <p class="text-gray-500 mb-4">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹è¨‚å–®</p>
            <button @click="loginLine" class="bg-[#06C755] text-white px-4 py-2 rounded font-bold">LINE ç™»å…¥</button>
        </div>
        <div v-else-if="myOrders.length === 0" class="text-center py-10 text-gray-400">
            å°šç„¡è¨‚å–®ç´€éŒ„
        </div>
        <div v-else class="space-y-4">
            <div v-for="order in myOrders" :key="order.order_id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-50">
                    <span class="text-xs text-gray-500">{{ new Date(order.created_at).toLocaleDateString() }}</span>
                    <span class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-600 font-bold">{{ order.status_detail || 'è™•ç†ä¸­' }}</span>
                </div>
                <div class="space-y-1 mb-3">
                    <div v-for="(item, i) in order.items" :key="i" class="flex justify-between text-sm">
                        <span class="text-gray-700">{{ item.name }} x{{item.qty}}</span>
                        <span class="font-bold text-gray-900">${{item.price * item.qty}}</span>
                    </div>
                </div>
                <div class="text-right pt-2 border-t border-gray-50">
                    <span class="text-xs text-gray-400 mr-2">è¨‚å–®ç·¨è™Ÿ: {{ order.order_id }}</span>
                    <span class="font-black text-red-600 text-lg">${{ order.total_amount }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around py-2 pb-6 z-50 max-w-md mx-auto shadow-[0_-4px_10px_rgba(0,0,0,0.02)]">
        <div class="bottom-nav-item" @click="contactLine">
            <i class="fa-brands fa-line text-[#06C755]"></i>
            <span>å®¢æœ</span>
        </div>
        
        <div class="bottom-nav-item" :class="{active: view==='orders'}" @click="fetchMyOrders(); view='orders'">
            <i class="fa-solid fa-file-lines"></i>
            <span>è¨‚å–®</span>
        </div>

        <div class="relative -top-6" @click="view='shop'">
            <div class="w-14 h-14 bg-teal-main rounded-full flex items-center justify-center text-white shadow-lg border-4 border-gray-50 transform hover:scale-105 transition active:scale-95">
                <i class="fa-solid fa-store text-2xl"></i>
            </div>
        </div>

        <div class="bottom-nav-item relative" :class="{active: view==='cart'}" @click="view='cart'">
            <i class="fa-solid fa-cart-shopping"></i>
            <span>è³¼ç‰©è»Š</span>
            <span v-if="cart.length>0" class="absolute top-0 right-2 bg-red-500 text-white text-[8px] w-3 h-3 rounded-full flex items-center justify-center">{{cart.length}}</span>
        </div>

        <div class="bottom-nav-item" :class="{active: view.includes('admin')}" @click="goToAdmin">
            <i class="fa-solid fa-user-gear"></i>
            <span>å¾Œå°</span>
        </div>
    </div>

  </div>

  <script>
    // ============================================
    // âš ï¸ è¨­å®šå€åŸŸï¼šè«‹å‹™å¿…å¡«å¯«æ‚¨çš„çœŸå¯¦è³‡æ–™
    // ============================================
    const API_BASE = 'https://insbuy-project.onrender.com/api'; 
    const SUPABASE_URL = 'https://robgmhyjdfizzxdddqzr.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_WlEj-PHW5HuMZ94HXNJYyA_pKYERes4';
    // ============================================

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    Vue.createApp({
        data() {
            return {
                view: 'shop',
                loading: false,
                user: null,
                currentShopId: 'S001',
                
                // å•†å®¶è³‡è¨Š
                shopName: 'æ‹æ‹è³¼é¸ç‰©',
                shopLogo: '',
                shopLineLink: '',
                
                // å•†å“èˆ‡è³¼ç‰©è»Š
                products: [],
                cart: [],
                selectedProduct: null,
                orderForm: { variant: '', qty: 1 },
                
                // å„ªæƒ åˆ¸
                couponCode: '',
                discount: 0,
                
                // è¨‚å–®
                myOrders: [],
                
                // å¾Œå°è³‡æ–™
                stats: { newOrders: 0, pendingShip: 0, shipped: 0 },
                adminOrderList: [],
                newCoupon: { code: '', discount: '' },
                
                // AI è§£æ
                aiInput: ''
            }
        },
        computed: {
            cartTotal() { return this.cart.reduce((sum, item) => sum + item.price * item.qty, 0); }
        },
        async mounted() {
            this.loading = true;
            await this.checkUser();
            await this.fetchShopInfo();
            await this.fetchProducts();
            
            // ç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ–
            supabaseClient.auth.onAuthStateChange((event, session) => {
                this.user = session?.user || null;
                if(this.user) this.fetchMyOrders();
            });
            
            // ç¶²å€åƒæ•¸è™•ç† (Admin Login / åˆ†äº«é€£çµ)
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('productId')) {
                const pid = urlParams.get('productId');
                const target = this.products.find(p => p.product_id === pid);
                if(target) this.openProduct(target);
            }
            if(urlParams.get('mode') === 'admin') {
                this.goToAdmin();
            }
            
            this.loading = false;
        },
        methods: {
            // --- ç”¨æˆ¶ç³»çµ± ---
            async checkUser() {
                const { data } = await supabaseClient.auth.getUser();
                this.user = data.user;
            },
            async loginLine() {
                this.loading = true;
                await supabaseClient.auth.signInWithOAuth({
                    provider: 'line',
                    options: { redirectTo: window.location.origin }
                });
            },
            async logout() {
                await supabaseClient.auth.signOut();
                this.user = null;
                this.view = 'shop';
                alert('å·²ç™»å‡º');
            },

            // --- è³‡æ–™è®€å– ---
            async fetchShopInfo() {
                const { data } = await supabaseClient.from('shops').select('*').eq('shop_id', this.currentShopId).single();
                if(data) {
                    this.shopName = data.name;
                    this.shopLogo = data.logo_url;
                    this.shopLineLink = data.line_contact_link;
                }
            },
            async fetchProducts() {
                const { data } = await supabaseClient.from('products').select('*').eq('status', 'OPEN').order('created_at', {ascending: false});
                this.products = data || [];
                // è™•ç†è¦æ ¼ JSON æ ¼å¼
                this.products.forEach(p => {
                    if (typeof p.variants === 'string') {
                        try { p.variants = JSON.parse(p.variants); } catch(e) { p.variants = []; }
                    }
                });
            },
            
            // --- è³¼ç‰©æµç¨‹ ---
            openProduct(p) {
                this.selectedProduct = p;
                this.orderForm = { variant: p.variants?.[0]?.name || '', qty: 1 };
                this.view = 'product';
                window.scrollTo(0,0);
            },
            addToCart() {
                if(this.selectedProduct.variants && this.selectedProduct.variants.length > 0 && !this.orderForm.variant) {
                    return alert('è«‹é¸æ“‡è¦æ ¼');
                }
                this.cart.push({
                    productId: this.selectedProduct.product_id,
                    name: this.selectedProduct.name,
                    price: this.selectedProduct.price,
                    images: this.selectedProduct.images,
                    variant: this.orderForm.variant,
                    qty: this.orderForm.qty
                });
                alert('å·²åŠ å…¥è³¼ç‰©è»Š');
                this.view = 'shop';
            },
            async applyCoupon() {
                if(!this.couponCode) return;
                this.loading = true;
                const { data } = await supabaseClient.from('coupons').select('*').eq('code', this.couponCode).eq('is_active', true).single();
                if(data) {
                    this.discount = data.discount_amount;
                    alert(`å„ªæƒ åˆ¸ç”Ÿæ•ˆï¼æŠ˜æŠµ $${this.discount}`);
                } else {
                    alert('å„ªæƒ åˆ¸ç„¡æ•ˆæˆ–å·²éæœŸ');
                    this.discount = 0;
                }
                this.loading = false;
            },
            
            // --- çµå¸³ (å‘¼å«å¾Œç«¯ API) ---
            async checkout() {
                // if(!this.user) return alert('è«‹å…ˆç™»å…¥ LINE æœƒå“¡æ‰èƒ½ä¸‹å–®å–”ï¼\n(è«‹é»æ“Šå³ä¸Šè§’çš„ç™»å…¥æŒ‰éˆ•)');
                if(this.cart.length === 0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
                
                const customerInfo = {
                    name: this.user.user_metadata.full_name || 'LINEç”¨æˆ¶',
                    phone: '0912345678', // ä¹‹å¾Œå¯æ”¹ç‚ºè®“ç”¨æˆ¶è¼¸å…¥
                    address: '7-11 é–€å¸‚å–è²¨', 
                    shipping: '7-11',
                    last5: '' 
                };

                const finalAmount = Math.max(0, this.cartTotal - this.discount);
                if(!confirm(`ç¢ºå®šè¦çµå¸³å—ï¼Ÿ\nç¸½é‡‘é¡ $${finalAmount}`)) return;

                this.loading = true;

                try {
                    const res = await fetch(`${API_BASE}/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            shopId: this.currentShopId,
                            items: this.cart,
                            customer: customerInfo,
                            total: finalAmount,
                            couponId: null, 
                            discount: this.discount
                        })
                    });
                    
                    const json = await res.json();
                    
                    if(json.status === 'success') {
                        alert(`ğŸ‰ ä¸‹å–®æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿï¼š${json.orderId}\næˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨å‡ºè²¨ï¼`);
                        this.cart = [];
                        this.discount = 0;
                        this.fetchMyOrders();
                        this.view = 'orders';
                    } else {
                        alert('ä¸‹å–®å¤±æ•—ï¼š' + (json.msg || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                } catch(e) {
                    alert('ç³»çµ±é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                    console.error(e);
                }
                
                this.loading = false;
            },

            // --- è¨‚å–®æŸ¥è©¢ ---
            async fetchMyOrders() {
                if(!this.user) return;
                // é€™è£¡æˆ‘å€‘ç”¨ customer_name ä¾†ç°¡å–®éæ¿¾ (æ­£å¼ç‰ˆæ‡‰å­˜ user_id åˆ° orders è¡¨)
                const { data } = await supabaseClient.from('orders')
                    .select('*')
                    .eq('customer_name', this.user.user_metadata.full_name)
                    .order('created_at', {ascending: false});
                this.myOrders = data || [];
                // è§£æ items JSON
                this.myOrders.forEach(o => {
                    if(typeof o.items === 'string') o.items = JSON.parse(o.items);
                });
            },

            // --- äº’å‹•èˆ‡åˆ†äº« ---
            contactLine() {
                if(this.shopLineLink) window.open(this.shopLineLink);
                else alert('è³£å®¶å°šæœªè¨­å®š LINE é€£çµ');
            },
            shareProduct() {
                const shareUrl = `${API_BASE}/share/product/${this.selectedProduct.product_id}`;
                navigator.clipboard.writeText(shareUrl).then(() => alert('é€£çµå·²è¤‡è£½ï¼è²¼åˆ° LINE æœƒé¡¯ç¤ºç²¾ç¾å¡ç‰‡'));
            },
            async parseAiOrder() {
                if(!this.aiInput) return;
                this.loading = true;
                try {
                    const res = await fetch(`${API_BASE}/ai-parse`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({text: this.aiInput})
                    });
                    const json = await res.json();
                    if(json.status === 'success' && json.data.length > 0) {
                        alert(`AI å¹«æ‚¨è­˜åˆ¥å‡º ${json.data.length} é …å•†å“ï¼`);
                        // é€™è£¡å¯ä»¥åŠ å…¥è‡ªå‹•åŠ å…¥è³¼ç‰©è»Šé‚è¼¯
                    } else {
                        alert('AI ç„¡æ³•è­˜åˆ¥ï¼Œè«‹ç¢ºèªæ ¼å¼ (ä¾‹å¦‚: ç´…è‰²+1)');
                    }
                } catch(e) { console.error(e); }
                this.loading = false;
            },

            // --- å¾Œå°ç®¡ç† ---
            goToAdmin() {
                // ç°¡æ˜“é©—è­‰ï¼šæª¢æŸ¥æ˜¯å¦æœ‰ adminCreds (ç™»å…¥å¾Œæœƒå­˜)
                const creds = localStorage.getItem('adminCreds');
                if(creds) {
                    this.view = 'admin-home';
                    this.fetchAdminData();
                } else {
                    this.view = 'admin-login';
                }
            },
            async adminLogin() {
                // é€™è£¡å‘¼å«åŸæœ¬çš„å¾Œç«¯ login API (çœç•¥å¯¦ä½œï¼Œç¶­æŒç›¸å®¹æ€§)
                // ç‚ºäº†æ–¹ä¾¿ç¤ºç¯„ï¼Œé€™è£¡ç›´æ¥æ¨¡æ“¬æˆåŠŸ
                if(this.loginForm.email === 'admin@example.com') { // æš«æ™‚å¯«æ­»æ¸¬è©¦
                    localStorage.setItem('adminCreds', JSON.stringify({email: this.loginForm.email}));
                    this.view = 'admin-home';
                    this.fetchAdminData();
                } else {
                    // æ­£å¼ç’°å¢ƒè«‹ç”¨ callApi('login')
                    this.view = 'admin-login'; 
                }
            },
            async fetchAdminData() {
                // 1. æŠ“è¨‚å–®
                const { data: orders } = await supabaseClient.from('orders').select('*').order('created_at', {ascending: false});
                this.adminOrderList = orders || [];
                
                // 2. ç®—æ•¸æ“š
                this.stats.newOrders = this.adminOrderList.length;
                this.stats.pendingShip = this.adminOrderList.filter(o => o.status_detail === 'paid').length;
                this.stats.shipped = this.adminOrderList.filter(o => o.status_detail === 'shipped').length;
            },
            async updateOrderStatus(order) {
                this.loading = true;
                await supabaseClient.from('orders').update({ status_detail: order.status_detail }).eq('order_id', order.order_id);
                alert('ç‹€æ…‹æ›´æ–°æˆåŠŸ');
                this.fetchAdminData(); // é‡æ–°æ•´ç†æ•¸æ“š
                this.loading = false;
            },
            async createCoupon() {
                if(!this.newCoupon.code) return;
                await supabaseClient.from('coupons').insert({
                    shop_id: this.currentShopId,
                    code: this.newCoupon.code,
                    discount_amount: this.newCoupon.discount,
                    is_active: true
                });
                alert('å„ªæƒ åˆ¸å»ºç«‹æˆåŠŸ');
                this.newCoupon = { code: '', discount: '' };
            },
            copyShopLink() {
                const url = window.location.origin + '?shopId=' + this.currentShopId;
                navigator.clipboard.writeText(url).then(() => alert('è³£å ´é€£çµå·²è¤‡è£½'));
            }
        }
    }).mount('#app');
  </script>
</body>
</html>